<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-translate="all_tickets_page_title">All Tickets - AlliTrack Admin</title>
    <script src="../../scripts/mobile-restriction.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="../../styles/shared/admin-side-head.css" />
    <link rel="stylesheet" href="../../styles/admin page/all-tickets.css" />
    <link rel="stylesheet" href="../../styles/shared/mobile-restriction.css" />
    <script src="../../scripts/preference-manager.js"></script>
    <script src="../../scripts/user-data-manager.js"></script>
</head>

<body>
    <!-- Mobile Access Denied Modal -->
    <div class="mobile-block-modal" id="mobileBlockModal">
        <div class="mobile-block-content">
            <div class="mobile-block-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <h2 class="mobile-block-title">Mobile Access Restricted</h2>
            <p class="mobile-block-message">
                The Admin Dashboard is optimized for desktop use only.
                Please access this page from a desktop or laptop computer
                for the best experience and full functionality.
            </p>
            <div class="mobile-block-buttons">
                <a href="../../../index.html" class="mobile-block-btn primary"
                    id="mobileLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Return to Login
                </a>
            </div>
        </div>
    </div>

    <div class="app">
        <div class="shell">
            <!-- Sidebar -->
            <aside class="sidebar" role="navigation" aria-label="Main Sidebar">
                <div class="brand">
                    <div class="logo">
                        <img src="../../../src/assets/images/AlliTrack Icon.png" alt="AlliTrack Logo" class="logo-img"
                            style="width: 32px; height: 32px;">
                    </div>
                    <div>
                        <div class="title">AlliTrack</div>
                        <div class="subtitle" data-translate="admin_dashboard">Admin Dashboard</div>
                    </div>
                </div>
                <nav class="nav">
                    <a href="../../pages/admin page/index-admin.html" data-section="dashboard">
                        <i class="fas fa-chart-line"></i> <span data-translate="dashboard">Dashboard</span>
                    </a>

                    <div class="nav-section" data-translate="ticket_management">Ticket Management</div>
                    <a href="../../pages/admin page/all-tickets.html" class="active" data-section="tickets">
                        <i class="fas fa-ticket-alt"></i> <span data-translate="all_tickets">All Tickets</span>
                    </a>
                    <a href="../../pages/admin page/staff-management.html" data-section="users">
                        <i class="fas fa-users"></i> <span data-translate="users_management">Staff Management</span>
                    </a>
                    <a href="../../pages/admin page/announcements.html" data-section="announcements">
                        <i class="fas fa-bullhorn"></i> <span data-translate="announcements">Announcements</span>
                    </a>

                    <div class="nav-section" data-translate="system_management">System Management</div>
                    <a href="../../pages/admin page/system-settings.html" data-section="system-settings">
                        <i class="fas fa-cogs"></i> <span data-translate="system_settings">System Settings</span>
                    </a>
                    <a href="../../pages/admin page/system-analytics.html" data-section="analytics">
                        <i class="fas fa-chart-bar"></i> <span data-translate="analytics">Analytics</span>
                    </a>
                    <a href="../../pages/admin page/system-logs.html" data-section="logs">
                        <i class="fas fa-clipboard-list"></i> <span data-translate="system_logs">System Logs</span>
                    </a>

                    <div class="nav-section" data-translate="admin_tools">Admin Tools</div>
                    <a href="../../pages/admin page/preferences.html" data-section="preferences">
                        <i class="fas fa-sliders-h"></i> <span data-translate="preferences">Preferences</span>
                    </a>
                    <a href="../../pages/admin page/profile-settings.html" data-section="profile-settings">
                        <i class="fas fa-user-cog"></i> <span data-translate="profile_settings">Profile Settings</span>
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <div class="version">v1.2.0</div>
                    <div>Business Alliance Inc.</div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main">
                <!-- Header -->
                <header class="header">
                    <div class="search" role="search" aria-label="Search Tickets">
                        <i class="fas fa-search" style="opacity:.6"></i>
                        <input id="ticketSearch" placeholder="Search tickets by ID, name, or priority..."
                            data-translate-placeholder="search_tickets" aria-label="Search tickets" />
                    </div>
                    <div class="header-actions">
                        <div style="text-align:right">
                            <div id="userName" style="font-weight:700">Admin</div>
                            <div id="userEmail" style="font-size:.82rem;color:var(--muted)">admin@allitrack.com</div>
                        </div>
                        <div class="account" id="accountBtn" aria-haspopup="true" aria-expanded="false">
                            <div id="userAvatar" class="avatar">A</div>
                            <i class="fas fa-chevron-down" style="opacity:.85"></i>
                        </div>
                        <div class="account-menu" id="accountMenu">
                            <div class="arrow"></div>
                            <a href="../../pages/admin page/profile-settings.html" data-translate="profile">Profile</a>
                            <a href="../../pages/admin page/preferences.html" data-translate="settings">Settings</a>
                            <a href="../../../index.html" id="logoutBtn" data-translate="logout">Logout</a>
                        </div>
                    </div>
                </header>

                <!-- All Tickets Content -->
                <div class="content">
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-content">
                            <h1><i class="fas fa-ticket-alt"></i> <span data-translate="all_tickets_title">All
                                    Tickets</span></h1>
                            <p class="subtitle" data-translate="all_tickets_description">Manage and monitor all support
                                tickets in the system</p>
                        </div>
                    </div>

                    <!-- Tickets Container -->
                    <div class="tickets-container">
                        <!-- Filters and Actions -->
                        <div class="tickets-toolbar">
                            <div class="filters">
                                <div class="filter-group">
                                    <label for="statusFilter" class="filter-label"
                                        data-translate="status">Status</label>
                                    <select id="statusFilter" class="filter-select">
                                        <option value="all" data-translate="all_status">All Status</option>
                                        <option value="open" data-translate="open">Open</option>
                                        <option value="in_progress" data-translate="in_progress">In Progress</option>
                                        <option value="resolved" data-translate="resolved">Resolved</option>
                                        <option value="closed" data-translate="closed">Closed</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="priorityFilter" class="filter-label"
                                        data-translate="priority">Priority</label>
                                    <select id="priorityFilter" class="filter-select">
                                        <option value="all" data-translate="all_priority">All Priority</option>
                                        <option value="low" data-translate="low">Low</option>
                                        <option value="medium" data-translate="medium">Medium</option>
                                        <option value="high" data-translate="high">High</option>
                                        <option value="urgent" data-translate="urgent">Urgent</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" id="clearFilters">
                                    <i class="fas fa-times"></i> <span data-translate="clear_filters">Clear
                                        Filters</span>
                                </button>
                            </div>
                            <div class="actions">
                                <button class="btn btn-danger" id="deleteTicketsBtn" style="display: none;">
                                    <i class="fas fa-trash-alt"></i> <span data-translate="delete_selected">Delete
                                        Selected</span>
                                </button>
                                <button class="btn btn-secondary" id="refreshTickets">
                                    <i class="fas fa-sync-alt"></i> <span data-translate="refresh">Refresh</span>
                                </button>
                            </div>
                        </div>

                        <!-- Tickets Table -->
                        <div class="tickets-table-container">
                            <div class="table-responsive">
                                <table class="tickets-table" id="ticketsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;">
                                                <input type="checkbox" id="selectAllTickets" title="Select All">
                                            </th>
                                            <th data-translate="ticket_id">Ticket ID</th>
                                            <th data-translate="requester">Requester</th>
                                            <th data-translate="assigned_to">Assigned To</th>
                                            <th data-translate="priority">Priority</th>
                                            <th data-translate="status">Status</th>
                                            <th data-translate="created">Created</th>
                                            <th data-translate="actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Ticket entries will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="pagination-container" id="paginationContainer">
                                <div class="pagination-info" id="paginationInfo"></div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="firstPageBtn" title="First Page">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="pagination-btn" id="prevPageBtn" title="Previous Page">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <div class="pagination-numbers" id="paginationNumbers"></div>
                                    <button class="pagination-btn" id="nextPageBtn" title="Next Page">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="pagination-btn" id="lastPageBtn" title="Last Page">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                                <div class="pagination-page-size">
                                    <label for="pageSizeSelect" data-translate="items_per_page">Items per page:</label>
                                    <select id="pageSizeSelect" class="page-size-select">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ============ FIXED: Ticket Details Modal with Sticky Header ============ -->
                        <div class="modal" id="ticketDetailsModal">
                            <div class="modal-content">
                                <!-- Modal Header with integrated ticket header (STICKY) -->
                                <div class="modal-header modal-header-ticket">
                                    <div class="modal-header-top">
                                        <h3>
                                            <i class="fas fa-ticket-alt"></i>
                                            <span data-translate="ticket_details">Ticket Details</span>
                                        </h3>
                                        <button class="modal-close" id="closeModal">&times;</button>
                                    </div>

                                    <!-- Ticket Header Content - Part of sticky header -->
                                    <div class="ticket-header" id="modalTicketHeader">
                                        <!-- Dynamically populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Scrollable Modal Body -->
                                <div class="modal-body">
                                    <div class="ticket-details-content" id="ticketDetailsContent">
                                        <!-- Ticket details will be populated here -->
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button class="btn btn-secondary" id="closeDetailsBtn"
                                        data-translate="close">Close</button>
                                </div>
                            </div>
                        </div>

                        <!-- Delete Confirmation Modal - FIXED: Sticky header/footer -->
                        <div class="modal" id="deleteConfirmationModal">
                            <div class="modal-content" style="max-width: 500px;">
                                <div class="modal-header">
                                    <div class="modal-header-top">
                                        <h3>
                                            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                                            <span data-translate="confirm_delete">Confirm Delete</span>
                                        </h3>
                                        <button class="modal-close" id="closeDeleteModal">&times;</button>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <p id="deleteMessage"></p>
                                    <div id="selectedTicketsList" class="selected-tickets-list"
                                        style="display: none; margin-top: 15px; max-height: 200px; overflow-y: auto;">
                                        <h4 style="margin-bottom: 10px; font-size: 0.9rem;">Selected Tickets:</h4>
                                        <ul id="ticketsToDeleteList"></ul>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" id="cancelDeleteBtn"
                                        data-translate="cancel">Cancel</button>
                                    <button class="btn btn-danger" id="confirmDeleteBtn"
                                        data-translate="confirm_delete_btn">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="site-footer">
                    <div>&copy; 2025 Business Alliance Inc.</div>
                    <div data-translate="admin_dashboard_template">AlliTrack Admin Dashboard</div>
                </footer>
            </main>
        </div>
    </div>

    <script>
        // Translation dictionary for tickets page
        const translations = {
            'en': {
                'all_tickets_page_title': 'All Tickets - AlliTrack Admin',
                'all_tickets_title': 'All Tickets',
                'all_tickets_description': 'Manage and monitor all support tickets in the system',
                'search_tickets': 'Search tickets by ID, name, or priority...',
                'total_tickets': 'Total Tickets',
                'open_tickets': 'Open',
                'resolved_tickets': 'Resolved',
                'status': 'Status',
                'all_status': 'All Status',
                'open': 'Open',
                'in_progress': 'In Progress',
                'resolved': 'Resolved',
                'closed': 'Closed',
                'priority': 'Priority',
                'all_priority': 'All Priority',
                'low': 'Low',
                'medium': 'Medium',
                'high': 'High',
                'urgent': 'Urgent',
                'clear_filters': 'Clear Filters',
                'refresh': 'Refresh',
                'ticket_id': 'Ticket ID',
                'requester': 'Requester',
                'assigned_to': 'Assigned To',
                'created': 'Created',
                'actions': 'Actions',
                'ticket_details': 'Ticket Details',
                'close': 'Close',
                'update_ticket': 'Update Ticket',
                'view_details': 'View Details',
                'edit': 'Edit',
                'delete': 'Delete',
                'description': 'Description',
                'category': 'Category',
                'department': 'Department',
                'last_updated': 'Last Updated',
                'due_date': 'Due Date',
                'email': 'Email',
                'ticket_updated': 'Ticket updated successfully',
                'ticket_refreshed': 'Tickets refreshed successfully',
                'no_tickets_found': 'No Tickets Found',
                'no_tickets_description': 'No tickets match your current filters. Try adjusting your search criteria.',
                'subject': 'Subject',
                'cancel': 'Cancel',
                'save_changes': 'Save Changes',
                'save': 'Save',
                'edit_ticket': 'Edit Ticket',
                'ticket_saved': 'Ticket saved successfully',
                'error_saving': 'Error saving ticket',
                'ticket_info': 'Ticket Information',
                'current_values': 'Current Values',
                'new_values': 'New Values',
                'select_all': 'Select All',
                'delete_selected': 'Delete Selected',
                'confirm_delete': 'Confirm Delete',
                'confirm_delete_btn': 'Delete',
                'delete_success': 'Tickets deleted successfully',
                'delete_error': 'Error deleting tickets',
                'no_tickets_selected': 'No tickets selected',
                'delete_ticket_confirm': 'Are you sure you want to delete this ticket?',
                'delete_tickets_confirm': 'Are you sure you want to delete {count} selected tickets?',
                'items_per_page': 'Items per page:',
                'showing': 'Showing',
                'to': 'to',
                'of': 'of',
                'tickets': 'tickets',
                'page': 'Page',
                'contact_number': 'Contact Number',
                'ticket_overview': 'Ticket Overview',
                'requester_info': 'Requester Information',
                'ticket_metadata': 'Ticket Metadata',
                'phone': 'Phone',
                'admin_dashboard': 'Admin Dashboard',
                'dashboard': 'Dashboard',
                'ticket_management': 'Ticket Management',
                'all_tickets': 'All Tickets',
                'users_management': 'Users Management',
                'announcements': 'Announcements',
                'system_management': 'System Management',
                'system_settings': 'System Settings',
                'analytics': 'Analytics',
                'system_logs': 'System Logs',
                'admin_tools': 'Admin Tools',
                'preferences': 'Preferences',
                'profile_settings': 'Profile Settings',
                'profile': 'Profile',
                'settings': 'Settings',
                'logout': 'Logout',
                'admin_dashboard_template': 'AlliTrack Admin Dashboard'
            },
            'fil': {
                'all_tickets_page_title': 'All Tickets - AlliTrack Admin',
                'all_tickets_title': 'Lahat ng Ticket',
                'all_tickets_description': 'Pamahalaan ang lahat ng support ticket sa system',
                'search_tickets': 'Maghanap ng ticket sa pamamagitan ng ID, pangalan, o priority...',
                'total_tickets': 'Kabuuan ng Ticket',
                'open_tickets': 'Bukas',
                'resolved_tickets': 'Nalutas',
                'status': 'Status',
                'all_status': 'Lahat ng Status',
                'open': 'Bukas',
                'in_progress': 'In Progress',
                'resolved': 'Nalutas',
                'closed': 'Sarado',
                'priority': 'Priority',
                'all_priority': 'Lahat ng Priority',
                'low': 'Mababa',
                'medium': 'Katamtaman',
                'high': 'Mataas',
                'urgent': 'Agad',
                'clear_filters': 'Tanggalin ang Filters',
                'refresh': 'I-refresh',
                'ticket_id': 'Ticket ID',
                'requester': 'Nag-request',
                'assigned_to': 'Itinalaga Sa',
                'created': 'Nilikha',
                'actions': 'Mga Aksyon',
                'ticket_details': 'Detalye ng Ticket',
                'close': 'Isara',
                'update_ticket': 'I-update ang Ticket',
                'view_details': 'View',
                'edit': 'I-edit',
                'delete': 'I-delete',
                'description': 'Deskripsyon',
                'category': 'Kategorya',
                'department': 'Department',
                'last_updated': 'Huling Na-update',
                'due_date': 'Takdang Petsa',
                'email': 'Email',
                'ticket_updated': 'Matagumpay na na-update ang ticket',
                'ticket_refreshed': 'Matagumpay na na-refresh ang mga ticket',
                'no_tickets_found': 'Walang Natagpuang Ticket',
                'no_tickets_description': 'Walang ticket na tumutugma sa iyong filters. Subukang baguhin ang iyong search.',
                'subject': 'Paksa',
                'cancel': 'Kanselahin',
                'save_changes': 'I-save ang Mga Pagbabago',
                'save': 'I-save',
                'edit_ticket': 'I-edit ang Ticket',
                'ticket_saved': 'Matagumpay na na-save ang ticket',
                'error_saving': 'Error sa pag-save ng ticket',
                'ticket_info': 'Impormasyon ng Ticket',
                'current_values': 'Kasalukuyang Halaga',
                'new_values': 'Bagong Halaga',
                'select_all': 'Piliin Lahat',
                'delete_selected': 'I-delete ang Napili',
                'confirm_delete': 'Kumpirmahin ang Pag-delete',
                'confirm_delete_btn': 'I-delete',
                'delete_success': 'Matagumpay na na-delete ang mga ticket',
                'delete_error': 'Error sa pag-delete ng mga ticket',
                'no_tickets_selected': 'Walang napiling ticket',
                'delete_ticket_confirm': 'Sigurado ka bang gusto mong i-delete ang ticket na ito?',
                'delete_tickets_confirm': 'Sigurado ka bang gusto mong i-delete ang {count} napiling mga ticket?',
                'items_per_page': 'Mga item bawat pahina:',
                'showing': 'Ipinapakita',
                'to': 'hanggang',
                'of': 'ng',
                'tickets': 'mga ticket',
                'page': 'Pahina',
                'contact_number': 'Numero ng Kontak',
                'ticket_overview': 'Pangkalahatang-ideya ng Ticket',
                'requester_info': 'Impormasyon ng Nag-request',
                'ticket_metadata': 'Metadata ng Ticket',
                'phone': 'Telepono',
                'admin_dashboard': 'Admin Dashboard',
                'dashboard': 'Dashboard',
                'ticket_management': 'Pamamahala ng Ticket',
                'all_tickets': 'Lahat ng Ticket',
                'users_management': 'Pamamahala ng User',
                'announcements': 'Mga Anunsyo',
                'system_management': 'Pamamahala ng Sistema',
                'system_settings': 'Mga Setting ng Sistema',
                'analytics': 'Analitika',
                'system_logs': 'Mga Log ng Sistema',
                'admin_tools': 'Mga Tool ng Admin',
                'preferences': 'Mga Kagustuhan',
                'profile_settings': 'Mga Setting ng Profile',
                'profile': 'Profile',
                'settings': 'Mga Setting',
                'logout': 'Logout',
                'admin_dashboard_template': 'AlliTrack Admin Dashboard'
            }
        };

        // Function to extract first name from email
        function getFirstNameFromEmail(email) {
            if (!email) return 'Unknown';
            const username = email.split('@')[0];
            if (username.includes('.')) {
                const firstName = username.split('.')[0];
                return firstName.charAt(0).toUpperCase() + firstName.slice(1);
            } else if (username.includes('_')) {
                const firstName = username.split('_')[0];
                return firstName.charAt(0).toUpperCase() + firstName.slice(1);
            } else {
                return username.charAt(0).toUpperCase() + username.slice(1);
            }
        }

        // Sample tickets data
        let sampleTickets = [
            {
                id: 'TKT-2025-001',
                subject: 'Login issues after system update',
                requester: 'john.doe@company.com',
                requesterFirstName: 'John',
                assignedTo: 'IT Support Team',
                priority: 'high',
                status: 'open',
                created: '2025-02-09 09:15:23',
                description: 'Users are experiencing login failures after the recent system update. Error code: AUTH-403. This issue affects multiple users across different departments.',
                category: 'Authentication',
                department: 'IT Support',
                lastUpdated: '2025-02-09 14:30:00',
                dueDate: '2025-02-12',
                contactNumber: '+1 (555) 123-4567'
            },
            {
                id: 'TKT-2025-002',
                subject: 'Dashboard performance optimization',
                requester: 'sarah.smith@partner.com',
                requesterFirstName: 'Sarah',
                assignedTo: 'Development Team',
                priority: 'medium',
                status: 'in_progress',
                created: '2025-02-08 14:20:10',
                description: 'Dashboard loading times have increased by 40% over the past week. Need optimization for better user experience. Particularly slow on mobile devices.',
                category: 'Performance',
                department: 'Development',
                lastUpdated: '2025-02-09 11:45:00',
                dueDate: '2025-02-15',
                contactNumber: '+1 (555) 987-6543'
            },
            {
                id: 'TKT-2025-003',
                subject: 'Invoice export formatting issue',
                requester: 'finance@allitrack.com',
                requesterFirstName: 'Finance',
                assignedTo: 'Admin Team',
                priority: 'low',
                status: 'resolved',
                created: '2025-02-07 11:30:45',
                description: 'PDF invoice export shows incorrect formatting for currency symbols. The issue occurs when exporting invoices with multiple currencies.',
                category: 'Billing',
                department: 'Finance',
                lastUpdated: '2025-02-08 16:15:00',
                dueDate: '2025-02-10',
                contactNumber: '+1 (555) 456-7890'
            },
            {
                id: 'TKT-2025-004',
                subject: 'Mobile app crash on iOS',
                requester: 'michael.brown@client.com',
                requesterFirstName: 'Michael',
                assignedTo: 'Mobile Team',
                priority: 'urgent',
                status: 'open',
                created: '2025-02-10 08:45:12',
                description: 'App crashes immediately after launch on iOS 17.2 devices. Users cannot access any features. Crash logs show memory allocation error.',
                category: 'Bug',
                department: 'Mobile Development',
                lastUpdated: '2025-02-10 10:30:00',
                dueDate: '2025-02-11',
                contactNumber: '+1 (555) 789-0123'
            },
            {
                id: 'TKT-2025-005',
                subject: 'Data export timeout issue',
                requester: 'analytics@company.com',
                requesterFirstName: 'Analytics',
                assignedTo: 'Backend Team',
                priority: 'medium',
                status: 'in_progress',
                created: '2025-02-09 16:30:22',
                description: 'Large data exports timeout after 5 minutes. Need to increase timeout or implement chunking functionality for better performance.',
                category: 'Performance',
                department: 'Backend',
                lastUpdated: '2025-02-10 09:15:00',
                dueDate: '2025-02-14',
                contactNumber: '+1 (555) 234-5678'
            },
            {
                id: 'TKT-2025-006',
                subject: 'User permission issue',
                requester: 'admin@company.com',
                requesterFirstName: 'Admin',
                assignedTo: 'Security Team',
                priority: 'high',
                status: 'open',
                created: '2025-02-10 11:20:33',
                description: 'Users cannot access their assigned modules after permission changes. This affects 15+ users in the sales department.',
                category: 'Security',
                department: 'IT Security',
                lastUpdated: '2025-02-10 14:45:00',
                dueDate: '2025-02-13',
                contactNumber: '+1 (555) 345-6789'
            },
            {
                id: 'TKT-2025-007',
                subject: 'Email notifications not sending',
                requester: 'support@allitrack.com',
                requesterFirstName: 'Support',
                assignedTo: 'Email Team',
                priority: 'medium',
                status: 'resolved',
                created: '2025-02-08 09:10:45',
                description: 'Users are not receiving email notifications for ticket updates. This affects customer communication and response times.',
                category: 'Email',
                department: 'Communication',
                lastUpdated: '2025-02-09 15:20:00',
                dueDate: '2025-02-09',
                contactNumber: '+1 (555) 901-2345'
            },
            {
                id: 'TKT-2025-008',
                subject: 'Dashboard widget loading slowly',
                requester: 'user123@company.com',
                requesterFirstName: 'User',
                assignedTo: 'Frontend Team',
                priority: 'low',
                status: 'closed',
                created: '2025-02-07 14:55:18',
                description: 'Chart widgets take more than 10 seconds to load on the dashboard. Users report frustration with the slow performance.',
                category: 'Performance',
                department: 'Frontend',
                lastUpdated: '2025-02-08 11:30:00',
                dueDate: '2025-02-10',
                contactNumber: '+1 (555) 678-9012'
            },
            {
                id: 'TKT-2025-009',
                subject: 'API rate limiting too strict',
                requester: 'developer@partner.com',
                requesterFirstName: 'Developer',
                assignedTo: 'API Team',
                priority: 'medium',
                status: 'in_progress',
                created: '2025-02-10 13:40:27',
                description: 'Current rate limit of 100 requests/hour is too low for our integration. Need to increase to 1000 requests/hour.',
                category: 'API',
                department: 'Integration',
                lastUpdated: '2025-02-10 16:10:00',
                dueDate: '2025-02-17',
                contactNumber: '+1 (555) 012-3456'
            },
            {
                id: 'TKT-2025-010',
                subject: 'Payment gateway timeout',
                requester: 'billing@company.com',
                requesterFirstName: 'Billing',
                assignedTo: 'Payment Team',
                priority: 'high',
                status: 'open',
                created: '2025-02-11 10:05:39',
                description: 'Payments failing due to 30-second timeout on gateway calls. This is causing transaction failures and customer complaints.',
                category: 'Payment',
                department: 'Finance',
                lastUpdated: '2025-02-11 11:30:00',
                dueDate: '2025-02-12',
                contactNumber: '+1 (555) 567-8901'
            },
            {
                id: 'TKT-2025-011',
                subject: 'Report generation error',
                requester: 'reports@allitrack.com',
                requesterFirstName: 'Reports',
                assignedTo: 'Reporting Team',
                priority: 'medium',
                status: 'resolved',
                created: '2025-02-09 12:25:14',
                description: 'Monthly reports fail with database connection error. The error occurs when generating reports with large datasets.',
                category: 'Reporting',
                department: 'Analytics',
                lastUpdated: '2025-02-10 09:45:00',
                dueDate: '2025-02-11',
                contactNumber: '+1 (555) 890-1234'
            },
            {
                id: 'TKT-2025-012',
                subject: 'UI alignment issues on mobile',
                requester: 'designer@company.com',
                requesterFirstName: 'Designer',
                assignedTo: 'UI Team',
                priority: 'low',
                status: 'open',
                created: '2025-02-10 15:30:55',
                description: 'Text and buttons misaligned on mobile devices below 320px width. This affects the user experience on smaller screens.',
                category: 'UI',
                department: 'Design',
                lastUpdated: '2025-02-10 16:45:00',
                dueDate: '2025-02-15',
                contactNumber: '+1 (555) 123-8901'
            }
        ];

        // Global variables
        let currentFilteredTickets = [];
        let currentlyEditingTicketId = null;
        let selectedTickets = new Set();
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ðŸš€ All Tickets: Starting initialization...');

            // Add Toast HTML element to body
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            document.body.appendChild(toast);

            // Initialize user data manager
            if (window.userDataManager) {
                window.userDataManager.initializeUserDisplay();
            }

            // Initialize preferences manager
            if (window.preferencesManager) {
                window.preferencesManager.initialize();
                window.preferencesManager.applyTheme();

                // Get current language from preferences manager
                const currentLang = window.preferencesManager.getCurrentLanguage() || 'en';
                applyTranslations(currentLang);
            } else {
                applyTranslations('en');
            }

            // Setup logout functionality
            setupLogout();

            // Setup account dropdown
            setTimeout(() => {
                console.log('ðŸ”„ Setting up account dropdown...');
                setupAccountDropdown();
            }, 50);

            // Load and display tickets
            loadTickets();

            // Setup event listeners
            setupEventListeners();

            // Setup pagination
            setupPagination();

            console.log('âœ… All Tickets page loaded');
        });

        // Account Dropdown Functionality
        function setupAccountDropdown() {
            console.log('ðŸ”§ Setting up account dropdown...');
            const accountBtn = document.getElementById("accountBtn");
            const accountMenu = document.getElementById("accountMenu");

            if (!accountBtn || !accountMenu) {
                console.error('âŒ Account dropdown elements not found!');
                return;
            }

            const newBtn = accountBtn.cloneNode(true);
            accountBtn.parentNode.replaceChild(newBtn, accountBtn);
            const freshBtn = document.getElementById("accountBtn");

            freshBtn.addEventListener("click", function (e) {
                console.log('ðŸŽ¯ Account button clicked!');
                e.stopPropagation();
                e.preventDefault();
                const isShowing = accountMenu.classList.contains("show");
                accountMenu.classList.toggle("show");
                freshBtn.setAttribute("aria-expanded", accountMenu.classList.contains("show"));
            });

            document.addEventListener("click", function (e) {
                if (accountMenu.classList.contains("show") &&
                    !freshBtn.contains(e.target) &&
                    !accountMenu.contains(e.target)) {
                    console.log('ðŸ”’ Closing dropdown (clicked outside)');
                    accountMenu.classList.remove("show");
                    freshBtn.setAttribute("aria-expanded", false);
                }
            });

            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape" && accountMenu.classList.contains("show")) {
                    console.log('ðŸ”’ Closing dropdown (Escape key)');
                    accountMenu.classList.remove("show");
                    freshBtn.setAttribute("aria-expanded", false);
                }
            });

            const menuItems = accountMenu.querySelectorAll("a");
            menuItems.forEach(item => {
                item.addEventListener("click", function () {
                    console.log('ðŸ”’ Closing dropdown (menu item clicked)');
                    accountMenu.classList.remove("show");
                    freshBtn.setAttribute("aria-expanded", false);
                });
            });

            freshBtn.style.cursor = 'pointer';
        }

        // Apply translations to the page
        function applyTranslations(language) {
            const lang = translations[language] ? language : 'en';
            const dict = translations[lang];

            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (dict[key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA' || element.tagName === 'SELECT') {
                        if (element.type !== 'text' && element.type !== 'email' && element.type !== 'password' && element.type !== 'tel') {
                            element.textContent = dict[key];
                        }
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = dict[key];
                    } else {
                        element.textContent = dict[key];
                    }
                }
            });

            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (dict[key]) {
                    element.placeholder = dict[key];
                }
            });

            if (dict['all_tickets_page_title']) {
                document.title = dict['all_tickets_page_title'];
            }
        }

        // Logout functionality
        function setupLogout() {
            console.log('ðŸ” Setting up logout functionality...');
            const existingLogoutBtns = document.querySelectorAll('#logoutBtn');
            existingLogoutBtns.forEach(btn => {
                const parent = btn.parentNode;
                const newBtn = btn.cloneNode(true);
                parent.replaceChild(newBtn, btn);
            });

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                console.log('âœ… Logout button found, attaching handler...');
                const logoutHandler = function (e) {
                    console.log('ðŸšª Logout button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    localStorage.removeItem('userData');
                    localStorage.removeItem('userProfile');
                    localStorage.removeItem('adminPreferences');
                    localStorage.removeItem('preferredTheme');
                    localStorage.removeItem('preferredLanguage');
                    console.log('ðŸ§¹ Cleared localStorage, redirecting to login...');
                    window.location.href = '../../../index.html';
                };
                logoutBtn.removeEventListener('click', logoutHandler);
                logoutBtn.addEventListener('click', logoutHandler);
            } else {
                console.error('âŒ Logout button not found!');
            }
        }

        // Load tickets and populate table
        function loadTickets() {
            const ticketsTableBody = document.querySelector('#ticketsTable tbody');
            if (!ticketsTableBody) return;

            ticketsTableBody.innerHTML = '';

            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();

            currentFilteredTickets = sampleTickets.filter(ticket => {
                if (statusFilter !== 'all' && ticket.status !== statusFilter) return false;
                if (priorityFilter !== 'all' && ticket.priority !== priorityFilter) return false;
                if (searchTerm) {
                    const searchableText = [
                        ticket.id, ticket.subject, ticket.requester,
                        ticket.requesterFirstName, ticket.assignedTo,
                        ticket.priority, ticket.status, ticket.category, ticket.department
                    ].join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }
                return true;
            });

            totalPages = Math.ceil(currentFilteredTickets.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const ticketsToDisplay = currentFilteredTickets.slice(startIndex, endIndex);

            if (ticketsToDisplay.length === 0) {
                selectedTickets.clear();
                updateDeleteButtonVisibility();
            }

            ticketsToDisplay.forEach(ticket => {
                if (!ticket.requesterFirstName) {
                    ticket.requesterFirstName = getFirstNameFromEmail(ticket.requester);
                }
                const row = createTicketRow(ticket);
                ticketsTableBody.appendChild(row);
            });

            updatePaginationDisplay();
        }

        // Create a table row for a ticket entry
        function createTicketRow(ticket) {
            const row = document.createElement('tr');
            row.dataset.ticketId = ticket.id;
            const isSelected = selectedTickets.has(ticket.id);

            let priorityBadge = '';
            switch (ticket.priority) {
                case 'low': priorityBadge = '<span class="badge badge-low">Low</span>'; break;
                case 'medium': priorityBadge = '<span class="badge badge-medium">Medium</span>'; break;
                case 'high': priorityBadge = '<span class="badge badge-high">High</span>'; break;
                case 'urgent': priorityBadge = '<span class="badge badge-urgent">Urgent</span>'; break;
            }

            let statusBadge = '';
            switch (ticket.status) {
                case 'open': statusBadge = '<span class="badge badge-open">Open</span>'; break;
                case 'in_progress': statusBadge = '<span class="badge badge-progress">Pending</span>'; break;
                case 'resolved': statusBadge = '<span class="badge badge-resolved">Resolved</span>'; break;
                case 'closed': statusBadge = '<span class="badge badge-closed">Closed</span>'; break;
            }

            row.innerHTML = `
                <td>
                    <input type="checkbox" class="ticket-checkbox" data-ticket-id="${ticket.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td><strong>${ticket.id}</strong></td>
                <td>
                    <div class="requester-info">
                        <div class="requester-name">${ticket.requesterFirstName}</div>
                    </div>
                </td>
                <td>${ticket.assignedTo}</td>
                <td>${priorityBadge}</td>
                <td>${statusBadge}</td>
                <td>${ticket.created.split(' ')[0]}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" data-ticket-id="${ticket.id}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-edit" data-ticket-id="${ticket.id}" title="Edit Ticket">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;

            const checkbox = row.querySelector('.ticket-checkbox');
            checkbox.addEventListener('change', function () {
                if (this.checked) selectedTickets.add(ticket.id);
                else selectedTickets.delete(ticket.id);
                updateDeleteButtonVisibility();
                updateSelectAllCheckbox();
            });

            row.querySelector('.btn-view').addEventListener('click', function () {
                showTicketDetails(ticket.id);
            });

            row.querySelector('.btn-edit').addEventListener('click', function () {
                editTicket(ticket.id);
            });

            return row;
        }

        // ============ FIXED: Show ticket details in modal with proper sticky header ============
        function showTicketDetails(ticketId) {
            const ticket = sampleTickets.find(t => t.id === ticketId);
            if (!ticket) return;

            const modal = document.getElementById('ticketDetailsModal');
            const modalTicketHeader = document.getElementById('modalTicketHeader');
            const detailsContent = document.getElementById('ticketDetailsContent');

            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            // Populate the ticket header inside modal header (STICKY)
            modalTicketHeader.innerHTML = `
                <div class="ticket-meta">
                    <div class="ticket-id">${ticket.id}</div>
                    <div class="ticket-date">${ticket.created.split(' ')[0]}</div>
                </div>
                <h2 class="ticket-subject">${ticket.subject}</h2>
                <div class="ticket-tags">
                    <span class="badge badge-${ticket.priority}">
                        <i class="fas fa-flag"></i> ${ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1)} Priority
                    </span>
                    <span class="badge badge-${ticket.status === 'in_progress' ? 'progress' : ticket.status}">
                        <i class="fas fa-circle"></i> ${ticket.status === 'in_progress' ? 'In Progress' : ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1)}
                    </span>
                </div>
            `;

            // Populate the scrollable content
            detailsContent.innerHTML = `
                <div class="ticket-sections">
                    <!-- Ticket Overview -->
                    <div class="ticket-section">
                        <div class="section-header">
                            <i class="fas fa-info-circle"></i>
                            <h3>${dict['ticket_overview'] || 'Ticket Overview'}</h3>
                        </div>
                        <div class="section-content">
                            <p class="ticket-description">${ticket.description}</p>
                        </div>
                    </div>
                    
                    <!-- Requester Information -->
                    <div class="ticket-section">
                        <div class="section-header">
                            <i class="fas fa-user"></i>
                            <h3>${dict['requester_info'] || 'Requester Information'}</h3>
                        </div>
                        <div class="section-content">
                            <div class="requester-details">
                                <div class="detail-item">
                                    <span class="detail-label">${dict['requester'] || 'Requester'}:</span>
                                    <span class="detail-value">${ticket.requesterFirstName}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">${dict['email'] || 'Email'}:</span>
                                    <span class="detail-value requester-email">${ticket.requester}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">${dict['contact_number'] || 'Contact Number'}:</span>
                                    <span class="detail-value phone-number">
                                        <i class="fas fa-phone"></i> ${ticket.contactNumber || '+1 (555) 000-0000'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket Metadata -->
                    <div class="ticket-section">
                        <div class="section-header">
                            <i class="fas fa-cogs"></i>
                            <h3>${dict['ticket_metadata'] || 'Ticket Metadata'}</h3>
                        </div>
                        <div class="section-content">
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <span class="metadata-label">${dict['assigned_to'] || 'Assigned To'}:</span>
                                    <span class="metadata-value">${ticket.assignedTo}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">${dict['category'] || 'Category'}:</span>
                                    <span class="metadata-value">${ticket.category}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">${dict['department'] || 'Department'}:</span>
                                    <span class="metadata-value">${ticket.department}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">${dict['created'] || 'Created'}:</span>
                                    <span class="metadata-value">${ticket.created}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">${dict['last_updated'] || 'Last Updated'}:</span>
                                    <span class="metadata-value">${ticket.lastUpdated}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">${dict['due_date'] || 'Due Date'}:</span>
                                    <span class="metadata-value">${ticket.dueDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Close button event listeners
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeDetailsBtn').addEventListener('click', closeModal);

            modal.classList.add('show');
        }

        // Edit ticket function
        function editTicket(ticketId) {
            const ticket = sampleTickets.find(t => t.id === ticketId);
            if (!ticket) return;

            currentlyEditingTicketId = ticketId;

            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            showEditModal(ticket, dict);
        }

        // Show edit modal with form
        function showEditModal(ticket, dict) {
            const currentPriority = ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1);
            const currentStatus = ticket.status === 'in_progress' ? 'In Progress' :
                ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1);

            const editModalHTML = `
                <div class="modal edit-modal" id="editTicketModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-header-top">
                                <h3>
                                    <i class="fas fa-edit"></i> 
                                    <span>${dict['edit_ticket'] || 'Edit Ticket'} - ${ticket.id}</span>
                                </h3>
                                <button class="modal-close" id="closeEditModal">&times;</button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="ticket-info-header">
                                <h4>${dict['ticket_info'] || 'Ticket Information'}</h4>
                                <p><strong>${dict['subject'] || 'Subject'}:</strong> ${ticket.subject}</p>
                                <p><strong>${dict['requester'] || 'Requester'}:</strong> ${ticket.requester}</p>
                            </div>
                            
                            <form id="editTicketForm" class="edit-form">
                                <div class="form-section">
                                    <h4>${dict['current_values'] || 'Current Values'}</h4>
                                    <div class="current-values">
                                        <div class="current-value-item">
                                            <span class="current-label">${dict['assigned_to'] || 'Assigned To'}:</span>
                                            <span class="current-value">${ticket.assignedTo}</span>
                                        </div>
                                        <div class="current-value-item">
                                            <span class="current-label">${dict['priority'] || 'Priority'}:</span>
                                            <span class="current-value badge badge-${ticket.priority}">${currentPriority}</span>
                                        </div>
                                        <div class="current-value-item">
                                            <span class="current-label">${dict['status'] || 'Status'}:</span>
                                            <span class="current-value badge badge-${ticket.status === 'in_progress' ? 'progress' : ticket.status}">${currentStatus}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <h4>${dict['new_values'] || 'New Values'}</h4>
                                    
                                    <div class="form-group">
                                        <label for="editAssignedTo">${dict['assigned_to'] || 'Assigned To'}</label>
                                        <select id="editAssignedTo" class="form-select">
                                            <option value="" disabled selected>Select team or person</option>
                                            <option value="IT Support Team" ${ticket.assignedTo === 'IT Support Team' ? 'selected' : ''}>IT Support Team</option>
                                            <option value="Development Team" ${ticket.assignedTo === 'Development Team' ? 'selected' : ''}>Development Team</option>
                                            <option value="Admin Team" ${ticket.assignedTo === 'Admin Team' ? 'selected' : ''}>Admin Team</option>
                                            <option value="Customer Support" ${ticket.assignedTo === 'Customer Support' ? 'selected' : ''}>Customer Support</option>
                                            <option value="Quality Assurance" ${ticket.assignedTo === 'Quality Assurance' ? 'selected' : ''}>Quality Assurance</option>
                                            <option value="Finance Department" ${ticket.assignedTo === 'Finance Department' ? 'selected' : ''}>Finance Department</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="editPriority">${dict['priority'] || 'Priority'}</label>
                                        <select id="editPriority" class="form-select">
                                            <option value="low" ${ticket.priority === 'low' ? 'selected' : ''}>${dict['low'] || 'Low'}</option>
                                            <option value="medium" ${ticket.priority === 'medium' ? 'selected' : ''}>${dict['medium'] || 'Medium'}</option>
                                            <option value="high" ${ticket.priority === 'high' ? 'selected' : ''}>${dict['high'] || 'High'}</option>
                                            <option value="urgent" ${ticket.priority === 'urgent' ? 'selected' : ''}>${dict['urgent'] || 'Urgent'}</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="editStatus">${dict['status'] || 'Status'}</label>
                                        <select id="editStatus" class="form-select">
                                            <option value="open" ${ticket.status === 'open' ? 'selected' : ''}>${dict['open'] || 'Open'}</option>
                                            <option value="in_progress" ${ticket.status === 'in_progress' ? 'selected' : ''}>${dict['in_progress'] || 'In Progress'}</option>
                                            <option value="resolved" ${ticket.status === 'resolved' ? 'selected' : ''}>${dict['resolved'] || 'Resolved'}</option>
                                            <option value="closed" ${ticket.status === 'closed' ? 'selected' : ''}>${dict['closed'] || 'Closed'}</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelEditBtn">${dict['cancel'] || 'Cancel'}</button>
                            <button class="btn btn-primary" id="saveEditBtn">${dict['save_changes'] || 'Save Changes'}</button>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('editTicketModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', editModalHTML);
            const editModal = document.getElementById('editTicketModal');
            editModal.classList.add('show');

            addEditFormStyles();
            setupEditModalListeners();
        }

        // Add CSS styles for edit form
        function addEditFormStyles() {
            if (document.getElementById('editFormStyles')) return;

            const style = document.createElement('style');
            style.id = 'editFormStyles';
            style.textContent = `
                .edit-form { display: flex; flex-direction: column; gap: 20px; }
                .ticket-info-header { background: var(--hover-bg); padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); }
                .ticket-info-header h4 { margin: 0 0 12px 0; font-size: 1rem; color: var(--text-primary); }
                .ticket-info-header p { margin: 8px 0; font-size: 0.9rem; color: var(--text-secondary); }
                .form-section { margin-bottom: 24px; }
                .form-section h4 { margin: 0 0 16px 0; font-size: 1rem; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border); padding-bottom: 8px; }
                .current-values { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px; }
                .current-value-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--hover-bg); border-radius: 6px; border: 1px solid var(--border); }
                .current-label { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
                .current-value { font-size: 0.9rem; color: var(--text-secondary); }
                .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
                .form-label { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
                .form-input, .form-textarea, .form-select { padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text-primary); font-size: 0.9rem; font-family: inherit; transition: all 0.2s var(--ease); }
                .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
                .form-textarea { resize: vertical; min-height: 100px; }
                .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; }
                @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; gap: 12px; } .current-value-item { flex-direction: column; align-items: flex-start; gap: 8px; } }
            `;
            document.head.appendChild(style);
        }

        // Setup edit modal event listeners
        function setupEditModalListeners() {
            const closeEditModalBtn = document.getElementById('closeEditModal');
            if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);

            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) cancelEditBtn.addEventListener('click', closeEditModal);

            const saveEditBtn = document.getElementById('saveEditBtn');
            if (saveEditBtn) saveEditBtn.addEventListener('click', saveTicketChanges);

            const editModalElement = document.getElementById('editTicketModal');
            if (editModalElement) {
                editModalElement.addEventListener('click', function (e) {
                    if (e.target === this) closeEditModal();
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const editModal = document.getElementById('editTicketModal');
                    if (editModal && editModal.classList.contains('show')) closeEditModal();
                }
            });
        }

        // Close edit modal
        function closeEditModal() {
            const editModal = document.getElementById('editTicketModal');
            if (editModal) {
                editModal.classList.remove('show');
                setTimeout(() => { editModal.remove(); }, 300);
            }
            currentlyEditingTicketId = null;
        }

        // Save ticket changes
        function saveTicketChanges() {
            if (!currentlyEditingTicketId) return;

            const ticketIndex = sampleTickets.findIndex(t => t.id === currentlyEditingTicketId);
            if (ticketIndex === -1) return;

            const assignedTo = document.getElementById('editAssignedTo').value;
            const status = document.getElementById('editStatus').value;
            const priority = document.getElementById('editPriority').value;

            if (!assignedTo || assignedTo === "Select team or person") {
                showToast('Please select a valid "Assigned To" value', 'error');
                return;
            }
            if (!status) { showToast('Please select a status', 'error'); return; }
            if (!priority) { showToast('Please select a priority', 'error'); return; }

            sampleTickets[ticketIndex].assignedTo = assignedTo;
            sampleTickets[ticketIndex].status = status;
            sampleTickets[ticketIndex].priority = priority;
            sampleTickets[ticketIndex].lastUpdated = getCurrentDateTime();

            loadTickets();

            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            showToast(dict['ticket_saved'] || 'Ticket saved successfully', 'success');
            closeEditModal();
        }

        // Helper function to get current date time
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Update delete button visibility
        function updateDeleteButtonVisibility() {
            const deleteBtn = document.getElementById('deleteTicketsBtn');
            if (deleteBtn) {
                if (selectedTickets.size > 0) {
                    deleteBtn.style.display = 'flex';
                    const currentLang = window.preferencesManager ?
                        window.preferencesManager.getCurrentLanguage() : 'en';
                    const dict = translations[currentLang] || translations['en'];
                    deleteBtn.innerHTML = `<i class="fas fa-trash-alt"></i> <span>${dict['delete_selected']} (${selectedTickets.size})</span>`;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
        }

        // Update select all checkbox state
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllTickets');
            if (!selectAllCheckbox) return;

            const currentPageTickets = getCurrentPageTicketIds();
            const allSelected = currentPageTickets.length > 0 &&
                currentPageTickets.every(id => selectedTickets.has(id));

            selectAllCheckbox.checked = allSelected;
            selectAllCheckbox.indeterminate = !allSelected &&
                currentPageTickets.some(id => selectedTickets.has(id));
        }

        // Get ticket IDs on current page
        function getCurrentPageTicketIds() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageTickets = currentFilteredTickets.slice(startIndex, endIndex);
            return currentPageTickets.map(ticket => ticket.id);
        }

        // Show delete confirmation modal
        function showDeleteConfirmation(ticketIds) {
            const modal = document.getElementById('deleteConfirmationModal');
            const deleteMessage = document.getElementById('deleteMessage');
            const ticketsList = document.getElementById('ticketsToDeleteList');
            const selectedTicketsList = document.getElementById('selectedTicketsList');

            if (!modal || !deleteMessage) return;

            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            ticketsList.innerHTML = '';

            if (ticketIds.length === 1) {
                const ticket = sampleTickets.find(t => t.id === ticketIds[0]);
                if (ticket) {
                    deleteMessage.textContent = dict['delete_ticket_confirm'] || 'Are you sure you want to delete this ticket?';
                    deleteMessage.innerHTML += `<br><br><strong>${ticket.id}</strong>: ${ticket.subject}`;
                    selectedTicketsList.style.display = 'none';
                }
            } else {
                const message = (dict['delete_tickets_confirm'] || 'Are you sure you want to delete {count} selected tickets?')
                    .replace('{count}', ticketIds.length);
                deleteMessage.textContent = message;

                ticketIds.forEach(ticketId => {
                    const ticket = sampleTickets.find(t => t.id === ticketId);
                    if (ticket) {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${ticket.id}</strong>: ${ticket.subject}`;
                        ticketsList.appendChild(li);
                    }
                });

                selectedTicketsList.style.display = 'block';
            }

            modal.classList.add('show');
        }

        // Delete selected tickets
        function deleteSelectedTickets() {
            if (selectedTickets.size === 0) {
                const currentLang = window.preferencesManager ?
                    window.preferencesManager.getCurrentLanguage() : 'en';
                const dict = translations[currentLang] || translations['en'];
                showToast(dict['no_tickets_selected'] || 'No tickets selected', 'error');
                return;
            }

            const ticketIdsToDelete = Array.from(selectedTickets);
            showDeleteConfirmation(ticketIdsToDelete);
        }

        // Confirm and execute deletion
        function confirmDeleteTickets() {
            const ticketIdsToDelete = Array.from(selectedTickets);
            sampleTickets = sampleTickets.filter(ticket => !selectedTickets.has(ticket.id));
            selectedTickets.clear();
            loadTickets();

            const modal = document.getElementById('deleteConfirmationModal');
            if (modal) modal.classList.remove('show');

            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];
            showToast(dict['delete_success'] || 'Tickets deleted successfully', 'success');
            updateDeleteButtonVisibility();
        }

        // Setup pagination
        function setupPagination() {
            document.getElementById('pageSizeSelect').addEventListener('change', function () {
                itemsPerPage = parseInt(this.value);
                currentPage = 1;
                loadTickets();
            });

            document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevPageBtn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('nextPageBtn').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('lastPageBtn').addEventListener('click', () => goToPage(totalPages));

            const selectAllCheckbox = document.getElementById('selectAllTickets');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function () {
                    const currentPageTicketIds = getCurrentPageTicketIds();

                    if (this.checked) {
                        currentPageTicketIds.forEach(id => selectedTickets.add(id));
                    } else {
                        currentPageTicketIds.forEach(id => selectedTickets.delete(id));
                    }

                    document.querySelectorAll('.ticket-checkbox').forEach(checkbox => {
                        const ticketId = checkbox.getAttribute('data-ticket-id');
                        checkbox.checked = selectedTickets.has(ticketId);
                    });

                    updateDeleteButtonVisibility();
                });
            }
        }

        // Update pagination display
        function updatePaginationDisplay() {
            const paginationNumbers = document.getElementById('paginationNumbers');
            const paginationInfo = document.getElementById('paginationInfo');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');

            if (!paginationNumbers || !paginationInfo) return;

            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, currentFilteredTickets.length);

            if (currentFilteredTickets.length === 0) {
                paginationInfo.textContent = `${dict['no_tickets_found'] || 'No tickets found'}`;
            } else {
                paginationInfo.textContent = `${dict['showing'] || 'Showing'} ${startIndex} ${dict['to'] || 'to'} ${endIndex} ${dict['of'] || 'of'} ${currentFilteredTickets.length} ${dict['tickets'] || 'tickets'}`;
            }

            paginationNumbers.innerHTML = '';
            addPageNumber(1, paginationNumbers);

            if (currentPage > 3) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                paginationNumbers.appendChild(ellipsis);
            }

            const startPage = Math.max(2, currentPage - 1);
            const endPage = Math.min(totalPages - 1, currentPage + 1);

            for (let i = startPage; i <= endPage; i++) {
                if (i !== 1 && i !== totalPages) addPageNumber(i, paginationNumbers);
            }

            if (currentPage < totalPages - 2) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                paginationNumbers.appendChild(ellipsis);
            }

            if (totalPages > 1) addPageNumber(totalPages, paginationNumbers);

            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;

            updateSelectAllCheckbox();
        }

        // Add page number button
        function addPageNumber(pageNumber, container) {
            const button = document.createElement('button');
            button.className = 'pagination-number';
            if (pageNumber === currentPage) button.classList.add('active');
            button.textContent = pageNumber;
            button.addEventListener('click', () => goToPage(pageNumber));
            container.appendChild(button);
        }

        // Go to specific page
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadTickets();
            const tableContainer = document.querySelector('.tickets-table-container');
            if (tableContainer) tableContainer.scrollTop = 0;
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('statusFilter').addEventListener('change', loadTickets);
            document.getElementById('priorityFilter').addEventListener('change', loadTickets);

            const clearFiltersBtn = document.getElementById('clearFilters');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function () {
                    document.getElementById('statusFilter').value = 'all';
                    document.getElementById('priorityFilter').value = 'all';
                    document.getElementById('ticketSearch').value = '';
                    loadTickets();
                    showToast('Filters cleared', 'success');
                });
            }

            const refreshBtn = document.getElementById('refreshTickets');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function () {
                    loadTickets();
                    const currentLang = window.preferencesManager ?
                        window.preferencesManager.getCurrentLanguage() : 'en';
                    const dict = translations[currentLang] || translations['en'];
                    showToast(dict['ticket_refreshed'] || 'Tickets refreshed successfully', 'success');
                });
            }

            const deleteBtn = document.getElementById('deleteTicketsBtn');
            if (deleteBtn) deleteBtn.addEventListener('click', deleteSelectedTickets);

            const closeDeleteModalBtn = document.getElementById('closeDeleteModal');
            if (closeDeleteModalBtn) {
                closeDeleteModalBtn.addEventListener('click', function () {
                    document.getElementById('deleteConfirmationModal').classList.remove('show');
                });
            }

            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            if (cancelDeleteBtn) {
                cancelDeleteBtn.addEventListener('click', function () {
                    document.getElementById('deleteConfirmationModal').classList.remove('show');
                });
            }

            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDeleteTickets);

            const deleteModal = document.getElementById('deleteConfirmationModal');
            if (deleteModal) {
                deleteModal.addEventListener('click', function (e) {
                    if (e.target === this) this.classList.remove('show');
                });
            }

            const searchInput = document.getElementById('ticketSearch');
            let searchTimeout;
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        currentPage = 1;
                        loadTickets();
                    }, 300);
                });
            }

            const closeModalBtn = document.getElementById('closeModal');
            const closeDetailsBtn = document.getElementById('closeDetailsBtn');

            if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (closeDetailsBtn) closeDetailsBtn.addEventListener('click', closeModal);

            const modalElement = document.getElementById('ticketDetailsModal');
            if (modalElement) {
                modalElement.addEventListener('click', function (e) {
                    if (e.target === this) closeModal();
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeModal();
                    const deleteModal = document.getElementById('deleteConfirmationModal');
                    if (deleteModal && deleteModal.classList.contains('show')) deleteModal.classList.remove('show');
                }
            });
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('ticketDetailsModal');
            if (modal) modal.classList.remove('show');
        }

        // Show toast message
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // Listen for language changes
        document.addEventListener('languageChanged', function (e) {
            applyTranslations(e.detail.language);
        });
    </script>
</body>

</html>