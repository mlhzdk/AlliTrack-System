<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-translate="notifications_page_title">Notifications - AlliTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="../../styles/shared/user-side-head.css" />
    <link rel="stylesheet" href="../../styles/user page/notification.css" />
    <link rel="stylesheet" href="../../styles/shared/mobile-restriction.css" />
    <script src="../../scripts/mobile-restriction.js"></script>
    <script src="../../scripts/user-preference-manager.js"></script>
    <script src="../../scripts/user-data-manager.js"></script>
</head>

<body>
    <!-- Mobile Access Denied Modal -->
    <div class="mobile-block-overlay">
        <div class="mobile-block-card">
            <i class="fas fa-laptop"></i>
            <h2 data-translate="mobile_restricted">Desktop only</h2>
            <p data-translate="mobile_block_message">User dashboard is optimized for larger screens. Please open on a
                desktop or tablet in landscape mode.</p>
            <button class="btn" onclick="window.location.href='../../../index.html'" data-translate="go_back">Back to
                Home</button>
        </div>
    </div>

    <div class="app">
        <div class="shell">
            <!-- Sidebar -->
            <aside class="sidebar" role="navigation" aria-label="Main Sidebar">
                <div class="brand">
                    <div class="logo">
                        <img src="../../assets/images/AlliTrack Logo.png" alt="AlliTrack Logo" class="logo-img"
                            style="width: 32px; height: 32px;">
                    </div>
                    <div>
                        <div class="title">AlliTrack</div>
                        <div class="subtitle" data-translate="user_dashboard">User Dashboard</div>
                    </div>
                </div>
                <nav class="nav">
                    <a href="../../pages/user page/index-user.html" data-section="dashboard">
                        <i class="fas fa-chart-line"></i> <span data-translate="dashboard">Dashboard</span>
                    </a>

                    <div class="nav-section" data-translate="support">Support</div>
                    <a href="../../pages/user page/my-tickets.html" data-section="tickets">
                        <i class="fas fa-ticket-alt"></i> <span data-translate="my_tickets">My Tickets</span>
                    </a>
                    <a href="../../pages/user page/notifications.html" class="active" data-section="notifications">
                        <i class="fas fa-bell"></i> <span data-translate="notifications">Notifications</span>
                    </a>
                    <a href="../../pages/user page/submit-ticket.html" data-section="submit-ticket">
                        <i class="fas fa-plus-circle"></i> <span data-translate="submit_ticket">Submit a Ticket</span>
                    </a>

                    <div class="nav-section" data-translate="management">Management</div>
                    <a href="../../pages/user page/preferences.html" data-section="preferences">
                        <i class="fas fa-sliders-h"></i> <span data-translate="preferences">Preferences</span>
                    </a>
                    <a href="../../pages/user page/profile-settings.html" data-section="profile-settings">
                        <i class="fas fa-user-cog"></i> <span data-translate="profile_settings">Profile Settings</span>
                    </a>
                    <a href="../../pages/user page/announcements.html" data-section="announcements">
                        <i class="fas fa-bullhorn"></i> <span data-translate="announcements">Announcements</span>
                    </a>

                    <div class="nav-section" data-translate="system">System</div>
                    <a href="../../pages/user page/account-security.html" data-section="account-security">
                        <i class="fas fa-shield-alt"></i> <span data-translate="account_security">Account
                            Security</span>
                    </a>
                    <a href="../../pages/user page/system-information.html" data-section="system-information">
                        <i class="fas fa-info-circle"></i> <span data-translate="system_information">System
                            Information</span>
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <div class="version">v1.2.0</div>
                    <div>Business Alliance Inc.</div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main">
                <!-- Header -->
                <header class="header">
                    <div class="search" role="search" aria-label="Search Tickets">
                        <i class="fas fa-search" style="opacity:.6"></i>
                        <input id="q" placeholder="Search notifications..."
                            data-translate-placeholder="search_notifications" />
                    </div>
                    <div class="header-actions">
                        <div style="text-align:right">
                            <div id="userName" style="font-weight:700">User</div>
                            <div id="userEmail" style="font-size:.82rem;color:var(--muted)">user@example.com</div>
                        </div>
                        <div class="account" id="accountBtn" aria-haspopup="true" aria-expanded="false">
                            <div id="userAvatar" class="avatar">U</div>
                            <i class="fas fa-chevron-down" style="opacity:.85"></i>
                        </div>
                        <div class="account-menu" id="accountMenu">
                            <div class="arrow"></div>
                            <a href="../../pages/user page/profile-settings.html" data-translate="profile">Profile</a>
                            <a href="../../pages/user page/preferences.html" data-translate="settings">Settings</a>
                            <a href="#" id="logoutBtn" data-translate="logout">Logout</a>
                        </div>
                    </div>
                </header>

                <!-- Notifications Content -->
                <div class="content">
                    <div class="notifications-content">
                        <!-- Header with Container -->
                        <div class="notifications-header-container">
                            <div class="notifications-header">
                                <h1><i class="fas fa-bell"></i> <span
                                        data-translate="notifications_title">Notifications</span></h1>
                                <div class="notifications-controls">
                                    <div class="filter-group">
                                        <button class="filter-btn active" data-filter="all">
                                            <span data-translate="filter_all">All</span>
                                        </button>
                                        <button class="filter-btn" data-filter="unread">
                                            <span data-translate="filter_unread">Unread</span>
                                        </button>
                                        <button class="filter-btn" data-filter="ticket">
                                            <span data-translate="filter_ticket">Ticket Updates</span>
                                        </button>
                                        <button class="filter-btn" data-filter="system">
                                            <span data-translate="filter_system">System</span>
                                        </button>
                                    </div>
                                    <button class="mark-all-read" id="markAllRead">
                                        <span data-translate="mark_all_read">Mark All as Read</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="notifications-stats">
                            <div class="stat-card">
                                <div class="stat-icon icon-update">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-count" id="totalNotifications">12</div>
                                    <div class="stat-label" data-translate="total_notifications">Total Notifications
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon icon-message">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-count" id="unreadCount">5</div>
                                    <div class="stat-label" data-translate="unread_notifications">Unread Notifications
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon icon-resolved">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-count" id="ticketUpdates">8</div>
                                    <div class="stat-label" data-translate="ticket_updates">Ticket Updates</div>
                                </div>
                            </div>
                        </div>

                        <!-- Add this container around the notifications grid -->
                        <div class="notifications-list-container">
                            <div class="notifications-grid" id="notificationsContainer">
                                <!-- Notifications will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="site-footer">
                    <div>&copy; 2025 Business Alliance Inc.</div>
                    <div data-translate="dashboard_template">Dashboard Template</div>
                </footer>
            </main>
        </div>
    </div>

    <script>
        // Translation dictionary for notifications page
        const translations = {
            'en': {
                // PAGE-SPECIFIC translations only:
                'notifications_page_title': 'Notifications - AlliTrack',
                'notifications_title': 'Notifications',
                'search_notifications': 'Search notifications...',
                'filter_all': 'All',
                'filter_unread': 'Unread',
                'filter_ticket': 'Ticket Updates',
                'filter_system': 'System',
                'mark_all_read': 'Mark All as Read',
                'total_notifications': 'Total Notifications',
                'unread_notifications': 'Unread Notifications',
                'ticket_updates': 'Ticket Updates',
                'no_notifications_found': 'No notifications found',
                'empty_state_message': 'Try adjusting your filters or check back later',
                'view_details': 'View Details',
                'mark_as_read': 'Mark as Read',
                'badge_ticket': 'ticket',
                'badge_system': 'system',
                'badge_urgent': 'urgent',

                // Navigation (shared with other pages)
                'user_dashboard': 'User Dashboard',
                'dashboard': 'Dashboard',
                'support': 'Support',
                'my_tickets': 'My Tickets',
                'notifications': 'Notifications',
                'submit_ticket': 'Submit a Ticket',
                'management': 'Management',
                'preferences': 'Preferences',
                'profile_settings': 'Profile Settings',
                'announcements': 'Announcements',
                'system': 'System',
                'account_security': 'Account Security',
                'system_information': 'System Information',
                'profile': 'Profile',
                'settings': 'Settings',
                'logout': 'Logout',
                'dashboard_template': 'Dashboard Template'
            },
            'fil': {
                // PAGE-SPECIFIC translations only:
                'notifications_page_title': 'Mga Paalala - AlliTrack',
                'notifications_title': 'Mga Paalala',
                'search_notifications': 'Maghanap ng mga paalala...',
                'filter_all': 'Lahat',
                'filter_unread': 'Hindi pa Nabasa',
                'filter_ticket': 'Mga Update',
                'filter_system': 'Sistema',
                'mark_all_read': 'Markahan Lahat ng Nabasa',
                'total_notifications': 'Kabuuang mga Paalala',
                'unread_notifications': 'Hindi pa Nababasang mga Paalala',
                'ticket_updates': 'Mga Update sa Ticket',
                'no_notifications_found': 'Walang nakitang mga paalala',
                'empty_state_message': 'Subukan ang pag-adjust ng iyong mga filter o magbalik mamaya',
                'view_details': 'Tingnan ang mga Detalye',
                'mark_as_read': 'Markahan bilang Nabasa',
                'badge_ticket': 'ticket',
                'badge_system': 'sistema',
                'badge_urgent': 'kagyat',

                // Navigation (shared with other pages)
                'user_dashboard': 'Dashboard ng User',
                'dashboard': 'Dashboard',
                'support': 'Suporta',
                'my_tickets': 'Mga Ticket',
                'notifications': 'Mga Paalala',
                'submit_ticket': 'Magsumite ng Ticket',
                'management': 'Pamamahala',
                'preferences': 'Mga Kagustuhan',
                'profile_settings': 'Mga Setting ng Profile',
                'announcements': 'Mga Anunsyo',
                'system': 'Sistema',
                'account_security': 'Seguridad ng Account',
                'system_information': 'Impormasyon ng Sistema',
                'profile': 'Profile',
                'settings': 'Mga Setting',
                'logout': 'Logout',
                'dashboard_template': 'Template ng Dashboard'
            }
        };

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Notifications: Starting initialization...');

            // Initialize user data manager FIRST
            if (window.userDataManager) {
                console.log('User Data Manager found, initializing user display...');
                window.userDataManager.initializeUserDisplay();

                // Check what user data is available
                const userData = window.userDataManager.getUserData();
                console.log('User Data from manager:', userData);
                console.log('Profile picture URL:', userData.photo);
            } else {
                console.error('User Data Manager NOT FOUND! Check if user-data-manager.js is loaded.');
            }

            // Initialize preferences manager
            if (window.preferencesManager) {
                console.log('Notifications: Initializing Preferences Manager...');
                window.preferencesManager.initialize();

                // Apply theme immediately
                window.preferencesManager.applyTheme();

                // Get current language from preferences manager
                const currentLang = window.preferencesManager.getCurrentLanguage() || 'en';
                applyTranslations(currentLang);
            } else {
                console.error('Notifications: preferencesManager not found!');
                applyTranslations('en'); // Default to English
            }

            // Setup theme listener
            setupThemeListener();

            // Initialize notifications functionality
            initNotifications();

            // Setup logout functionality
            setupLogout();

            // SETUP ACCOUNT DROPDOWN - CRITICAL ADDITION (from system-information.html)
            setupAccountDropdown();

            console.log('Notifications page loaded');
        });

        // Setup theme listener
        function setupThemeListener() {
            console.log('Setting up theme listener for notifications...');

            // Listen for theme changes via storage events
            window.addEventListener('storage', (event) => {
                if (event.key === 'preferredTheme') {
                    console.log('Theme changed via storage:', event.newValue);
                    if (window.preferencesManager) {
                        setTimeout(() => {
                            window.preferencesManager.applyTheme();
                        }, 100);
                    }
                }
            });

            // Listen for theme changes via broadcast
            document.addEventListener('themeChanged', function (e) {
                console.log('Theme changed via event:', e.detail.theme);
                if (window.preferencesManager) {
                    window.preferencesManager.applyTheme();
                }
            });
        }

        // Apply translations to the page
        function applyTranslations(language) {
            const lang = translations[language] ? language : 'en';
            const dict = translations[lang];

            // Translate all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (dict[key]) {
                    element.textContent = dict[key];
                }
            });

            // Translate all placeholder texts
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (dict[key]) {
                    element.placeholder = dict[key];
                }
            });

            // Update page title
            if (dict['notifications_page_title']) {
                document.title = dict['notifications_page_title'];
            }

            // Re-render notifications to update badges and action buttons
            if (typeof filterNotifications === 'function') {
                filterNotifications(getActiveFilter());
            }
        }

        // Listen for language changes from preference-manager.js
        document.addEventListener('languageChanged', function (e) {
            console.log('Language changed to:', e.detail.language);
            applyTranslations(e.detail.language);
        });

        // Logout functionality
        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Clear user data from localStorage
                    localStorage.removeItem('userData');
                    localStorage.removeItem('userProfile');

                    // Redirect to login page
                    window.location.href = '../../../index.html';
                });
            }
        }

        // Sample notification data
        const notifications = [
            {
                id: 1,
                type: "ticket-update",
                title: "Ticket Updated",
                message: "Your ticket #TKT-4587 has been updated by support agent Sarah Johnson.",
                ticketId: "TKT-4587",
                ticketTitle: "Login authentication issue",
                time: "2025-03-17T14:30:00",
                unread: true,
                badge: "ticket"
            },
            {
                id: 2,
                type: "new-message",
                title: "New Message from Support",
                message: "You have received a new message regarding your ticket #TKT-4392 about email notifications.",
                ticketId: "TKT-4392",
                ticketTitle: "Email notifications not being sent",
                time: "2025-03-17T11:15:00",
                unread: true,
                badge: "urgent"
            },
            {
                id: 3,
                type: "ticket-resolved",
                title: "Ticket Resolved",
                message: "Your ticket #TKT-4219 has been resolved and closed by the support team.",
                ticketId: "TKT-4219",
                ticketTitle: "Dashboard not loading properly",
                time: "2025-03-16T16:45:00",
                unread: false,
                badge: "ticket"
            },
            {
                id: 4,
                type: "system-alert",
                title: "System Maintenance",
                message: "Scheduled system maintenance will occur on March 20, 2025 from 2:00 AM to 4:00 AM UTC.",
                time: "2025-03-16T10:20:00",
                unread: true,
                badge: "system"
            },
            {
                id: 5,
                type: "ticket-closed",
                title: "Ticket Closed",
                message: "Your ticket #TKT-4125 has been closed as the issue has been resolved.",
                ticketId: "TKT-4125",
                ticketTitle: "Report generation slow",
                time: "2025-03-15T09:10:00",
                unread: false,
                badge: "ticket"
            },
            {
                id: 6,
                type: "new-message",
                title: "New Message from Support",
                message: "Support agent Mike Davis has requested additional information for ticket #TKT-4673.",
                ticketId: "TKT-4673",
                ticketTitle: "Unable to upload large files",
                time: "2025-03-14T15:30:00",
                unread: false,
                badge: "ticket"
            },
            {
                id: 7,
                type: "ticket-update",
                title: "Priority Changed",
                message: "The priority of your ticket #TKT-4392 has been changed to Critical.",
                ticketId: "TKT-4392",
                ticketTitle: "Email notifications not being sent",
                time: "2025-03-14T13:45:00",
                unread: false,
                badge: "urgent"
            },
            {
                id: 8,
                type: "system-alert",
                title: "New Feature Available",
                message: "The new reporting dashboard is now available. Check it out in the Reports section.",
                time: "2025-03-13T08:30:00",
                unread: false,
                badge: "system"
            }
        ];

        // Format date function
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format relative time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

            if (diffInMinutes < 1) {
                return 'Just now';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes} min ago`;
            } else if (diffInHours < 24) {
                return `${diffInHours} hr ago`;
            } else if (diffInDays === 1) {
                return 'Yesterday';
            } else if (diffInDays < 7) {
                return `${diffInDays} days ago`;
            } else {
                return formatDate(dateString);
            }
        }

        // Get icon class based on notification type
        function getIconClass(type) {
            switch (type) {
                case 'ticket-update':
                    return 'icon-update';
                case 'new-message':
                    return 'icon-message';
                case 'ticket-resolved':
                    return 'icon-resolved';
                case 'ticket-closed':
                    return 'icon-closed';
                case 'system-alert':
                    return 'icon-system';
                default:
                    return 'icon-update';
            }
        }

        // Get icon based on notification type
        function getIcon(type) {
            switch (type) {
                case 'ticket-update':
                    return 'fas fa-sync-alt';
                case 'new-message':
                    return 'fas fa-comment-alt';
                case 'ticket-resolved':
                    return 'fas fa-check-circle';
                case 'ticket-closed':
                    return 'fas fa-times-circle';
                case 'system-alert':
                    return 'fas fa-info-circle';
                default:
                    return 'fas fa-bell';
            }
        }

        // Update statistics
        function updateStats() {
            const total = notifications.length;
            const unread = notifications.filter(n => n.unread).length;
            const ticketUpdates = notifications.filter(n =>
                n.type === 'ticket-update' ||
                n.type === 'ticket-resolved' ||
                n.type === 'ticket-closed' ||
                n.type === 'new-message'
            ).length;

            const totalNotificationsEl = document.getElementById('totalNotifications');
            const unreadCountEl = document.getElementById('unreadCount');
            const ticketUpdatesEl = document.getElementById('ticketUpdates');

            if (totalNotificationsEl) totalNotificationsEl.textContent = total;
            if (unreadCountEl) unreadCountEl.textContent = unread;
            if (ticketUpdatesEl) ticketUpdatesEl.textContent = ticketUpdates;
        }

        // Render notifications
        function renderNotifications(notificationsToRender) {
            const notificationsContainer = document.getElementById('notificationsContainer');

            if (!notificationsContainer) return;

            notificationsContainer.innerHTML = '';

            if (notificationsToRender.length === 0) {
                const currentLang = window.preferencesManager ? window.preferencesManager.getCurrentLanguage() || 'en' : 'en';
                const dict = translations[currentLang] || translations['en'];

                notificationsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <h3>${dict['no_notifications_found'] || 'No notifications found'}</h3>
                    <p>${dict['empty_state_message'] || 'Try adjusting your filters or check back later'}</p>
                </div>
            `;
                return;
            }

            // Get current language for translation
            const currentLang = window.preferencesManager ? window.preferencesManager.getCurrentLanguage() || 'en' : 'en';
            const dict = translations[currentLang] || translations['en'];

            notificationsToRender.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-card ${notification.unread ? 'unread' : ''}`;

                let ticketLink = '';
                if (notification.ticketId) {
                    ticketLink = `
                    <a href="#" class="notification-ticket">
                        <i class="fas fa-ticket-alt"></i>
                        <span>${notification.ticketId}: ${notification.ticketTitle}</span>
                    </a>
                `;
                }

                notificationElement.innerHTML = `
                <div class="notification-header">
                    <div class="notification-type">
                        <div class="notification-icon ${getIconClass(notification.type)}">
                            <i class="${getIcon(notification.type)}"></i>
                        </div>
                        <div>
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-time">${formatRelativeTime(notification.time)}</div>
                        </div>
                    </div>
                    <div class="notification-badge badge-${notification.badge}">
                        ${dict[`badge_${notification.badge}`] || notification.badge}
                    </div>
                </div>
                <div class="notification-content">
                    <div class="notification-message">${notification.message}</div>
                    ${ticketLink}
                </div>
                <div class="notification-actions">
                    <button class="notification-action-btn" data-id="${notification.id}" data-action="view">
                        <i class="fas fa-eye"></i> ${dict['view_details'] || 'View Details'}
                    </button>
                    ${notification.unread ? `
                        <button class="notification-action-btn primary" data-id="${notification.id}" data-action="mark-read">
                            <i class="fas fa-check"></i> ${dict['mark_as_read'] || 'Mark as Read'}
                        </button>
                    ` : ''}
                </div>
            `;
                notificationsContainer.appendChild(notificationElement);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.notification-action-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const notificationId = parseInt(this.getAttribute('data-id'));
                    const action = this.getAttribute('data-action');

                    if (action === 'mark-read') {
                        markAsRead(notificationId);
                    } else if (action === 'view') {
                        viewNotification(notificationId);
                    }
                });
            });
        }

        // Filter notifications
        function filterNotifications(filter) {
            let filteredNotifications = [...notifications];

            switch (filter) {
                case 'unread':
                    filteredNotifications = filteredNotifications.filter(n => n.unread);
                    break;
                case 'ticket':
                    filteredNotifications = filteredNotifications.filter(n =>
                        n.type === 'ticket-update' ||
                        n.type === 'ticket-resolved' ||
                        n.type === 'ticket-closed' ||
                        n.type === 'new-message'
                    );
                    break;
                case 'system':
                    filteredNotifications = filteredNotifications.filter(n => n.type === 'system-alert');
                    break;
                case 'all':
                default:
                    // No filtering needed
                    break;
            }

            // Apply search filter
            const searchInput = document.getElementById('q');
            if (searchInput && searchInput.value.trim() !== '') {
                const searchTerm = searchInput.value.toLowerCase();
                filteredNotifications = filteredNotifications.filter(notification =>
                    notification.title.toLowerCase().includes(searchTerm) ||
                    notification.message.toLowerCase().includes(searchTerm) ||
                    (notification.ticketId && notification.ticketId.toLowerCase().includes(searchTerm))
                );
            }

            // Sort by time (newest first)
            filteredNotifications.sort((a, b) => new Date(b.time) - new Date(a.time));

            renderNotifications(filteredNotifications);
        }

        // Mark notification as read
        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.unread = false;
                updateStats();
                filterNotifications(getActiveFilter());
            }
        }

        // Mark all notifications as read
        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.unread = false;
            });
            updateStats();
            filterNotifications(getActiveFilter());
        }

        // View notification details
        function viewNotification(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                // In a real app, this would navigate to the ticket or show details
                alert(`Viewing notification: ${notification.title}\n\n${notification.message}`);

                // Mark as read when viewed
                if (notification.unread) {
                    markAsRead(id);
                }
            }
        }

        // Get active filter
        function getActiveFilter() {
            const activeBtn = document.querySelector('.filter-btn.active');
            return activeBtn ? activeBtn.getAttribute('data-filter') : 'all';
        }

        // Initialize notifications functionality
        function initNotifications() {
            // Add event listeners for filters and search
            const filterButtons = document.querySelectorAll('.filter-btn');
            const markAllReadBtn = document.getElementById('markAllRead');
            const searchInput = document.getElementById('q');

            // Filter buttons
            if (filterButtons) {
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', function () {
                        filterButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        filterNotifications(this.getAttribute('data-filter'));
                    });
                });
            }

            // Mark all as read button
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllAsRead);
            }

            // Search input
            if (searchInput) {
                searchInput.addEventListener('input', () => filterNotifications(getActiveFilter()));
            }

            // Initial render
            updateStats();
            filterNotifications('all');
        }

        // Account Dropdown Functionality - FIXED VERSION (from system-information.html)
        function setupAccountDropdown() {
            console.log('Setting up account dropdown...');
            const accountBtn = document.getElementById("accountBtn");
            const accountMenu = document.getElementById("accountMenu");

            console.log('Dropdown elements:', { accountBtn, accountMenu });

            if (accountBtn && accountMenu) {
                // Clear any existing event listeners by cloning
                const newBtn = accountBtn.cloneNode(true);
                accountBtn.parentNode.replaceChild(newBtn, accountBtn);

                const refreshedBtn = document.getElementById("accountBtn");
                const refreshedMenu = document.getElementById("accountMenu");

                // Add click event
                refreshedBtn.addEventListener("click", function (e) {
                    console.log('Account button clicked!');
                    e.stopPropagation();
                    e.preventDefault();

                    const isShowing = refreshedMenu.classList.contains("show");
                    console.log('Current show state:', isShowing);

                    refreshedMenu.classList.toggle("show");
                    refreshedBtn.setAttribute("aria-expanded", !isShowing);
                    console.log('New show state:', !isShowing);
                });

                // Close dropdown when clicking outside
                document.addEventListener("click", function (e) {
                    if (!refreshedBtn.contains(e.target) && !refreshedMenu.contains(e.target)) {
                        refreshedMenu.classList.remove("show");
                        refreshedBtn.setAttribute("aria-expanded", false);
                    }
                });

                // Close dropdown when pressing Escape key
                document.addEventListener("keydown", function (e) {
                    if (e.key === "Escape" && refreshedMenu.classList.contains("show")) {
                        refreshedMenu.classList.remove("show");
                        refreshedBtn.setAttribute("aria-expanded", false);
                    }
                });

                // Close dropdown when clicking menu items
                const menuItems = refreshedMenu.querySelectorAll("a");
                menuItems.forEach(item => {
                    item.addEventListener("click", function () {
                        refreshedMenu.classList.remove("show");
                        refreshedBtn.setAttribute("aria-expanded", false);
                    });
                });

                // Make sure button is clickable
                refreshedBtn.style.cursor = 'pointer';

                console.log('Account dropdown setup complete');
            } else {
                console.error('Account dropdown elements not found!');
            }
        }

        // Listen for user data changes
        document.addEventListener('userDataChanged', function (e) {
            console.log('User data changed event received:', e.detail);
        });
    </script>

</body>

</html>