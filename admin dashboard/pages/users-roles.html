<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - AlliTrack — Users & Roles</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="../css/header-sidebar.css" />
    <link rel="stylesheet" href="../css/users-roles.css" />
</head>

<body>
    <div class="app">
        <div class="shell">
            <!-- Sidebar -->
            <aside class="sidebar" role="navigation" aria-label="Main Sidebar">
                <div class="brand">
                    <div class="logo">AT</div>
                    <div>
                        <div class="title">AlliTrack</div>
                        <div class="subtitle">Admin Dashboard</div>
                    </div>
                </div>
                <nav class="nav">
                    <a href="../pages/index-admin.html" data-section="dashboard">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <div class="nav-section">Tickets</div>
                    <a href="../pages/tickets.html" data-section="tickets">
                        <i class="fas fa-ticket-alt"></i> All Tickets
                    </a>
                    <div class="nav-section">Management</div>
                    <a href="../pages/users-roles.html" class="active" data-section="users">
                        <i class="fas fa-users"></i> Users & Roles
                    </a>
                    <a href="../pages/reports.html" ata-section="reports">
                        <i class="fas fa-file-alt"></i> Reports
                    </a>
                    <div class="nav-section">System</div>
                    <a href="#" data-section="integration">
                        <i class="fas fa-plug"></i> Integration
                    </a>
                    <a href="../pages/settings.html" data-section="settings">
                        <i class="fas fa-gear"></i> System Settings
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <div class="version">v1.2.0</div>
                    <div>Business Alliance Inc.</div>
                </div>
            </aside>

            <!-- Main -->
            <main class="main">
                <!-- Header -->
                <header class="header">
                    <div class="search" role="search" aria-label="Search Users">
                        <i class="fas fa-search" style="opacity:.6"></i>
                        <input id="searchInput" placeholder="Search users, emails, usernames..." aria-label="Search users" />
                    </div>
                    <div class="header-actions">
                        <div style="text-align:right">
                            <!-- Dynamic user data will be inserted here -->
                            <div style="font-weight:700" id="userName">Admin User</div>
                            <div style="font-size:.82rem;color:var(--muted)" id="userEmail">Administrator</div>
                        </div>
                        <div class="account" id="accountBtn" aria-haspopup="true" aria-expanded="false">
                            <!-- Dynamic avatar initials -->
                            <div class="avatar" id="userAvatar">AJ</div>
                            <i class="fas fa-chevron-down" style="opacity:.85"></i>
                        </div>
                        <div class="account-menu" id="accountMenu">
                            <div class="arrow"></div>
                            <a href="../pages/settings.html">Settings</a>
                            <a href="#" id="logoutBtn">Logout</a>
                        </div>
                    </div>
                </header>

                <section class="content">
                    <!-- Users Controls -->
                    <div class="users-controls">
                        <div class="controls-left">
                            <h1 class="page-title">Users & Roles</h1>
                            <div class="users-count">Showing <span id="usersCount">0</span> users</div>
                        </div>
                        <div class="controls-right">
                            <div class="filter-group">
                                <label for="roleFilter">Role:</label>
                                <select id="roleFilter" class="filter-select">
                                    <option value="all">All Roles</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="statusFilter">Status:</label>
                                <select id="statusFilter" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <button class="btn-primary" id="btnAddUser">
                                <i class="fas fa-plus"></i> Add User
                            </button>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Email / Username</th>
                                    <th>Status</th>
                                    <th>Tickets</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTbody">
                                <!-- Users will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Roles & Activity Cards -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3>Roles Management</h3>
                            </div>
                            <div class="card-body">
                                <div class="roles-header">
                                    <div class="small-muted">Define user roles & permissions</div>
                                    <button class="btn-primary" id="btnAddRole">
                                        <i class="fas fa-plus"></i> Add Role
                                    </button>
                                </div>
                                <div class="roles-list" id="rolesList">
                                    <!-- Roles will be populated here by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>User Activity</h3>
                            </div>
                            <div class="card-body">
                                <div class="small-muted" style="margin-bottom:16px;">Last logins & recent actions</div>
                                <div id="activityList" class="activity-list">
                                    <!-- Activity will be populated here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <footer class="site-footer">
                    <div>&copy; 2025 Business Alliance Inc.</div>
                    <div>Dashboard Template</div>
                </footer>
            </main>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add User</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <!-- Modal content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load and display user data from localStorage - EXACTLY as in index-admin.html
        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            
            if (userData) {
                // Display user name
                const userNameElement = document.getElementById('userName');
                if (userNameElement && userData.name) {
                    userNameElement.textContent = userData.name;
                }
                
                // Display user email
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement && userData.email) {
                    userEmailElement.textContent = userData.email;
                }
                
                // Display avatar initials
                const userAvatarElement = document.getElementById('userAvatar');
                if (userAvatarElement && userData.name) {
                    // Get initials from name
                    const nameParts = userData.name.split(' ');
                    let initials = '';
                    
                    if (nameParts.length >= 2) {
                        initials = nameParts[0].charAt(0) + nameParts[1].charAt(0);
                    } else if (nameParts.length === 1) {
                        initials = nameParts[0].charAt(0);
                        if (nameParts[0].length > 1) {
                            initials += nameParts[0].charAt(1);
                        }
                    }
                    
                    userAvatarElement.textContent = initials.toUpperCase();
                }
            } else {
                // If no user data, redirect to login page
                window.location.href = '../../landing page/pages/index.html';
            }
        }
        
        // Call the function when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            initializeUsersRolesPage();
        });

        // Dropdown toggle - EXACTLY as in index-admin.html
        const accountBtn = document.getElementById("accountBtn");
        const accountMenu = document.getElementById("accountMenu");

        if (accountBtn && accountMenu) {
            accountBtn.addEventListener("click", () => {
                accountMenu.classList.toggle("show");
                accountBtn.setAttribute("aria-expanded", accountMenu.classList.contains("show"));
            });

            window.addEventListener("click", (e) => {
                if (!accountBtn.contains(e.target) && !accountMenu.contains(e.target)) {
                    accountMenu.classList.remove("show");
                    accountBtn.setAttribute("aria-expanded", false);
                }
            });
        }

        // Logout functionality - EXACTLY as in index-admin.html
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();

                // Clear user data from localStorage
                localStorage.removeItem('userData');

                // Redirect to login page
                window.location.href = '../../landing page/pages/index.html';
            });
        }

        // Sample data
        let sampleRoles = [
            { id: 'admin', name: 'Admin', description: 'Full access', permissions: ['all'] },
            { id: 'tech', name: 'Technical Staff', description: 'Can view and resolve assigned tickets', permissions: ['tickets_view', 'tickets_resolve'] },
            { id: 'viewer', name: 'Viewer', description: 'View tickets & reports', permissions: ['tickets_view'] },
            { id: 'approver', name: 'Ticket Approver', description: 'Can escalate but not resolve', permissions: ['tickets_view', 'tickets_escalate'] }
        ];

        let users = [
            { id: 1, name: 'Ana Torres', email: 'ana@ba.inc', username: 'ana.t', role: 'admin', status: 'active', joined: '2025-03-12', ticketsAssigned: 12, ticketsResolved: 10, lastLogin: '2025-11-25 09:12', activity: ['Resolved #4581', 'Assigned #4590'] },
            { id: 2, name: 'Mark Rivera', email: 'mark@ba.inc', username: 'mark.r', role: 'tech', status: 'active', joined: '2025-05-02', ticketsAssigned: 24, ticketsResolved: 20, lastLogin: '2025-11-26 14:32', activity: ['Commented on #4603', 'Closed #4599'] },
            { id: 3, name: 'Clara B', email: 'clara@ba.inc', username: 'clara.b', role: 'viewer', status: 'inactive', joined: '2025-06-18', ticketsAssigned: 0, ticketsResolved: 0, lastLogin: '2025-09-11 11:00', activity: ['Viewed report: Monthly'] },
            { id: 4, name: 'Jude Park', email: 'jude@ba.inc', username: 'jude.p', role: 'approver', status: 'active', joined: '2025-07-21', ticketsAssigned: 5, ticketsResolved: 2, lastLogin: '2025-11-20 08:42', activity: ['Escalated #4620'] }
        ];

        // DOM Elements for users & roles functionality
        const usersTbody = document.getElementById("usersTbody");
        const searchInput = document.getElementById("searchInput");
        const roleFilter = document.getElementById("roleFilter");
        const statusFilter = document.getElementById("statusFilter");
        const usersCount = document.getElementById("usersCount");
        const userModal = document.getElementById("userModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalContent = document.getElementById("modalContent");
        const closeModal = document.querySelector(".close");
        const rolesList = document.getElementById("rolesList");
        const activityList = document.getElementById("activityList");
        const btnAddUser = document.getElementById("btnAddUser");
        const btnAddRole = document.getElementById("btnAddRole");

        let currentEditingUser = null;
        let currentEditingRole = null;

        // Initialize users & roles page
        function initializeUsersRolesPage() {
            renderUsers(users);
            renderRolesList();
            renderActivity();
            setupUsersRolesEventListeners();
            populateRoleFilters();
        }

        // Set up event listeners for users & roles functionality
        function setupUsersRolesEventListeners() {
            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }
            
            // Filter functionality
            if (roleFilter) {
                roleFilter.addEventListener('change', handleFilter);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', handleFilter);
            }
            
            // Modal functionality
            if (closeModal) {
                closeModal.addEventListener('click', closeUserModal);
            }
            
            // Button events
            if (btnAddUser) {
                btnAddUser.addEventListener('click', openAddUserModal);
            }
            if (btnAddRole) {
                btnAddRole.addEventListener('click', openAddRoleModal);
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === userModal) {
                    closeUserModal();
                }
            });
        }

        // Populate role filters
        function populateRoleFilters() {
            if (!roleFilter) return;
            
            roleFilter.innerHTML = '<option value="all">All Roles</option>';
            sampleRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleFilter.appendChild(option);
            });
        }

        // Render users to the table
        function renderUsers(usersToRender) {
            if (!usersTbody) return;
            
            usersTbody.innerHTML = '';
            
            usersToRender.forEach(user => {
                const tr = document.createElement("tr");
                
                // Determine badge class based on status
                let badgeClass = user.status === 'active' ? 'badge-active' : 'badge-inactive';
                
                tr.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${user.name.split(' ').map(n => n[0]).join('')}</div>
                            <div class="user-details">
                                <div class="user-name">${user.name}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="role-info">
                            <div class="role-name">${getRoleName(user.role)}</div>
                            <div class="role-description">${getRoleDescription(user.role)}</div>
                        </div>
                    </td>
                    <td>
                        <div class="username">${user.username}</div>
                    </td>
                    <td>
                        <span class="badge ${badgeClass}">${user.status}</span>
                    </td>
                    <td>
                        <div class="tickets-info">
                            <div class="tickets-assigned">${user.ticketsAssigned} assigned</div>
                            <div class="tickets-resolved">${user.ticketsResolved} resolved</div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" title="Edit" onclick="openEditUserModal(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-edit" title="Activity" onclick="viewUserActivity(${user.id})">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="btn-edit" title="${user.status === 'active' ? 'Deactivate' : 'Activate'}" onclick="toggleUserStatus(${user.id})">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button class="btn-edit" title="Delete" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                usersTbody.appendChild(tr);
            });
            
            // Update users count
            if (usersCount) {
                usersCount.textContent = usersToRender.length;
            }
        }

        // Render roles list
        function renderRolesList() {
            if (!rolesList) return;
            
            rolesList.innerHTML = '';
            
            sampleRoles.forEach(role => {
                const roleItem = document.createElement('div');
                roleItem.className = 'role-item';
                roleItem.innerHTML = `
                    <div class="role-content">
                        <div class="role-name">${role.name}</div>
                        <div class="role-description">${role.description}</div>
                    </div>
                    <div class="role-actions">
                        <button class="btn-edit" onclick="openEditRoleModal('${role.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-edit" onclick="deleteRole('${role.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                rolesList.appendChild(roleItem);
            });
        }

        // Render activity list
        function renderActivity() {
            if (!activityList) return;
            
            activityList.innerHTML = '';
            
            const recentUsers = users.slice().sort((a, b) => new Date(b.lastLogin) - new Date(a.lastLogin)).slice(0, 5);
            
            recentUsers.forEach(user => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-user">
                        <div class="activity-name">${user.name}</div>
                        <div class="activity-role">${getRoleName(user.role)}</div>
                    </div>
                    <div class="activity-details">
                        <div class="activity-login">Last login: ${user.lastLogin}</div>
                        <div class="activity-actions">${user.activity.slice(0, 2).join(' • ') || 'No recent activity'}</div>
                    </div>
                `;
                activityList.appendChild(activityItem);
            });
        }

        // Handle search functionality
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            
            const filteredUsers = users.filter(user => {
                return user.name.toLowerCase().includes(searchTerm) ||
                       user.email.toLowerCase().includes(searchTerm) ||
                       user.username.toLowerCase().includes(searchTerm);
            });
            
            applyFilters(filteredUsers);
        }

        // Handle filter changes
        function handleFilter() {
            applyFilters(users);
        }

        // Apply both role and status filters
        function applyFilters(usersToFilter) {
            const roleValue = roleFilter.value;
            const statusValue = statusFilter.value;
            
            let filteredUsers = usersToFilter;
            
            if (roleValue !== 'all') {
                filteredUsers = filteredUsers.filter(user => user.role === roleValue);
            }
            
            if (statusValue !== 'all') {
                filteredUsers = filteredUsers.filter(user => user.status === statusValue);
            }
            
            renderUsers(filteredUsers);
        }

        // Open add user modal
        function openAddUserModal() {
            currentEditingUser = null;
            if (!modalTitle || !modalContent) return;
            
            modalTitle.textContent = 'Add New User';
            modalContent.innerHTML = `
                <div class="modal-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName">Name</label>
                            <input type="text" id="userName" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userUsername">Username</label>
                            <input type="text" id="userUsername" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="userPassword">Password</label>
                            <input type="password" id="userPassword" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" class="form-select">
                                ${sampleRoles.map(role => `<option value="${role.id}">${role.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userStatus">Status</label>
                            <select id="userStatus" class="form-select">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveUser()">Create User</button>
                </div>
            `;
            if (userModal) userModal.style.display = 'block';
        }

        // Open edit user modal
        function openEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            currentEditingUser = user;
            if (!modalTitle || !modalContent) return;
            
            modalTitle.textContent = `Edit User - ${user.name}`;
            modalContent.innerHTML = `
                <div class="modal-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName">Name</label>
                            <input type="text" id="userName" class="form-input" value="${user.name}">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" class="form-input" value="${user.email}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userUsername">Username</label>
                            <input type="text" id="userUsername" class="form-input" value="${user.username}">
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" class="form-select">
                                ${sampleRoles.map(role => `<option value="${role.id}" ${role.id === user.role ? 'selected' : ''}>${role.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userStatus">Status</label>
                            <select id="userStatus" class="form-select">
                                <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">Reset Password (leave blank to keep current)</label>
                            <input type="password" id="userPassword" class="form-input">
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <div>
                        <button class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                        <button class="btn-secondary" onclick="toggleUserStatus(${user.id})">${user.status === 'active' ? 'Deactivate' : 'Activate'}</button>
                    </div>
                    <div>
                        <button class="btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        <button class="btn-primary" onclick="saveUser()">Save Changes</button>
                    </div>
                </div>
            `;
            if (userModal) userModal.style.display = 'block';
        }

        // Open add role modal
        function openAddRoleModal() {
            currentEditingRole = null;
            if (!modalTitle || !modalContent) return;
            
            modalTitle.textContent = 'Add New Role';
            modalContent.innerHTML = `
                <div class="modal-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="roleId">Role ID</label>
                            <input type="text" id="roleId" class="form-input" placeholder="e.g., manager">
                        </div>
                        <div class="form-group">
                            <label for="roleName">Role Name</label>
                            <input type="text" id="roleName" class="form-input" placeholder="e.g., Manager">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="roleDescription">Description</label>
                            <input type="text" id="roleDescription" class="form-input" placeholder="Role description">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Permissions</label>
                            <div class="permissions-list">
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="tickets_view">
                                    View Tickets
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="tickets_resolve">
                                    Resolve Tickets
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="tickets_escalate">
                                    Escalate Tickets
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="users_view">
                                    View Users
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="reports_view">
                                    View Reports
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveRole()">Create Role</button>
                </div>
            `;
            if (userModal) userModal.style.display = 'block';
        }

        // Open edit role modal
        function openEditRoleModal(roleId) {
            const role = sampleRoles.find(r => r.id === roleId);
            if (!role) return;
            
            currentEditingRole = role;
            if (!modalTitle || !modalContent) return;
            
            modalTitle.textContent = `Edit Role - ${role.name}`;
            modalContent.innerHTML = `
                <div class="modal-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="roleId">Role ID</label>
                            <input type="text" id="roleId" class="form-input" value="${role.id}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="roleName">Role Name</label>
                            <input type="text" id="roleName" class="form-input" value="${role.name}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="roleDescription">Description</label>
                            <input type="text" id="roleDescription" class="form-input" value="${role.description}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Permissions</label>
                            <div class="permissions-list">
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="tickets_view" ${role.permissions.includes('tickets_view') || role.permissions.includes('all') ? 'checked' : ''}>
                                    View Tickets
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="tickets_resolve" ${role.permissions.includes('tickets_resolve') || role.permissions.includes('all') ? 'checked' : ''}>
                                    Resolve Tickets
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="tickets_escalate" ${role.permissions.includes('tickets_escalate') || role.permissions.includes('all') ? 'checked' : ''}>
                                    Escalate Tickets
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="users_view" ${role.permissions.includes('users_view') || role.permissions.includes('all') ? 'checked' : ''}>
                                    View Users
                                </label>
                                <label class="permission-item">
                                    <input type="checkbox" name="permissions" value="reports_view" ${role.permissions.includes('reports_view') || role.permissions.includes('all') ? 'checked' : ''}>
                                    View Reports
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button class="btn-danger" onclick="deleteRole('${role.id}')">Delete Role</button>
                    <button class="btn-primary" onclick="saveRole()">Save Changes</button>
                </div>
            `;
            if (userModal) userModal.style.display = 'block';
        }

        // Close user modal
        function closeUserModal() {
            if (userModal) userModal.style.display = 'none';
            currentEditingUser = null;
            currentEditingRole = null;
        }

        // Save user
        function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;

            if (!name || !email || !username) {
                alert('Please fill in all required fields.');
                return;
            }

            if (currentEditingUser) {
                // Update existing user
                currentEditingUser.name = name;
                currentEditingUser.email = email;
                currentEditingUser.username = username;
                currentEditingUser.role = role;
                currentEditingUser.status = status;
                
                if (password) {
                    currentEditingUser.activity.unshift('Password reset by Admin');
                }
                currentEditingUser.activity.unshift('Profile updated by Admin');
                
                alert('User updated successfully!');
            } else {
                // Create new user
                const newUser = {
                    id: Math.max(...users.map(u => u.id)) + 1,
                    name,
                    email,
                    username,
                    role,
                    status,
                    joined: new Date().toISOString().split('T')[0],
                    ticketsAssigned: 0,
                    ticketsResolved: 0,
                    lastLogin: new Date().toISOString().replace('T', ' ').substring(0, 16),
                    activity: ['Account created by Admin']
                };
                users.push(newUser);
                alert('User created successfully!');
            }

            closeUserModal();
            renderUsers(users);
            renderActivity();
            applyFilters(users);
        }

        // Save role
        function saveRole() {
            const id = document.getElementById('roleId').value.trim();
            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim();
            
            const permissionCheckboxes = document.querySelectorAll('input[name="permissions"]:checked');
            const permissions = Array.from(permissionCheckboxes).map(cb => cb.value);

            if (!id || !name) {
                alert('Please fill in all required fields.');
                return;
            }

            if (currentEditingRole) {
                // Update existing role
                currentEditingRole.name = name;
                currentEditingRole.description = description;
                currentEditingRole.permissions = permissions;
                alert('Role updated successfully!');
            } else {
                // Create new role
                if (sampleRoles.find(r => r.id === id)) {
                    alert('Role ID already exists. Please choose a different one.');
                    return;
                }
                
                const newRole = {
                    id,
                    name,
                    description,
                    permissions
                };
                sampleRoles.push(newRole);
                alert('Role created successfully!');
            }

            closeUserModal();
            renderRolesList();
            populateRoleFilters();
            applyFilters(users);
        }

        // Toggle user status
        function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = user.status === 'active' ? 'inactive' : 'active';
                user.activity.unshift(`${user.status === 'active' ? 'Activated' : 'Deactivated'} by Admin`);
                renderUsers(users);
                renderActivity();
                closeUserModal();
            }
        }

        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                users = users.filter(u => u.id !== userId);
                renderUsers(users);
                renderActivity();
                closeUserModal();
            }
        }

        // Delete role
        function deleteRole(roleId) {
            if (roleId === 'admin') {
                alert('Cannot delete the Admin role.');
                return;
            }

            const usersWithRole = users.filter(u => u.role === roleId);
            if (usersWithRole.length > 0) {
                if (!confirm(`This role is assigned to ${usersWithRole.length} user(s). Deleting it will reassign them to Viewer role. Continue?`)) {
                    return;
                }
                // Reassign users to viewer role
                users.forEach(u => {
                    if (u.role === roleId) {
                        u.role = 'viewer';
                    }
                });
            }

            sampleRoles = sampleRoles.filter(r => r.id !== roleId);
            renderRolesList();
            populateRoleFilters();
            renderUsers(users);
            closeUserModal();
        }

        // View user activity
        function viewUserActivity(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            if (!modalTitle || !modalContent) return;
            
            modalTitle.textContent = `User Activity - ${user.name}`;
            modalContent.innerHTML = `
                <div class="modal-section">
                    <div class="activity-details">
                        <div class="activity-info">
                            <strong>Last Login:</strong> ${user.lastLogin}
                        </div>
                        <div class="activity-history">
                            <strong>Recent Activity:</strong>
                            <ul>
                                ${user.activity.map(activity => `<li>${activity}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="closeUserModal()">Close</button>
                </div>
            `;
            if (userModal) userModal.style.display = 'block';
        }

        // Helper functions
        function getRoleName(roleId) {
            const role = sampleRoles.find(r => r.id === roleId);
            return role ? role.name : roleId;
        }

        function getRoleDescription(roleId) {
            const role = sampleRoles.find(r => r.id === roleId);
            return role ? role.description : '';
        }

        // Expose functions to global scope for onclick handlers
        window.openEditUserModal = openEditUserModal;
        window.toggleUserStatus = toggleUserStatus;
        window.deleteUser = deleteUser;
        window.viewUserActivity = viewUserActivity;
        window.openEditRoleModal = openEditRoleModal;
        window.deleteRole = deleteRole;
        window.closeUserModal = closeUserModal;
        window.saveUser = saveUser;
        window.saveRole = saveRole;
    </script>
</body>
</html>