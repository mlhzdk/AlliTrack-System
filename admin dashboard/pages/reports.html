<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reports - AlliTrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/header-sidebar.css" />
    <link rel="stylesheet" href="../css/reports.css" />
</head>

<body>
    <div class="app">
        <div class="shell">
            <!-- Sidebar -->
            <aside class="sidebar" role="navigation" aria-label="Main Sidebar">
                <div class="brand">
                    <div class="logo">AT</div>
                    <div>
                        <div class="title">AlliTrack</div>
                        <div class="subtitle">Admin Dashboard</div>
                    </div>
                </div>
                <nav class="nav">
                    <a href="../pages/index-admin.html" data-section="dashboard">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <div class="nav-section">Tickets</div>
                    <a href="../pages/tickets.html" data-section="tickets">
                        <i class="fas fa-ticket-alt"></i> All Tickets
                    </a>
                    <div class="nav-section">Management</div>
                    <a href="../pages/users-roles.html" data-section="users">
                        <i class="fas fa-users"></i> Users & Roles
                    </a>
                    <a href="../pages/reports.html" class="active" data-section="reports">
                        <i class="fas fa-file-alt"></i> Reports
                    </a>
                    <div class="nav-section">System</div>
                    <a href="#" data-section="integration">
                        <i class="fas fa-plug"></i> Integration
                    </a>
                    <a href="../pages/settings.html" data-section="settings">
                        <i class="fas fa-gear"></i> System Settings
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <div class="version">v1.2.0</div>
                    <div>Business Alliance Inc.</div>
                </div>
            </aside>

            <!-- Main -->
            <main class="main">
                <!-- Header -->
                <header class="header">
                    <div class="search" role="search" aria-label="Search Reports">
                        <i class="fas fa-search" style="opacity:.6"></i>
                        <input id="searchInput" placeholder="Search reports, categories, dates..." aria-label="Search reports, categories, dates" />
                    </div>
                    <div class="header-actions">
                        <div style="text-align:right">
                            <!-- Dynamic user data will be inserted here -->
                            <div style="font-weight:700" id="userName">Admin User</div>
                            <div style="font-size:.82rem;color:var(--muted)" id="userEmail">Administrator</div>
                        </div>
                        <div class="account" id="accountBtn" aria-haspopup="true" aria-expanded="false">
                            <!-- Dynamic avatar initials -->
                            <div class="avatar" id="userAvatar">AJ</div>
                            <i class="fas fa-chevron-down" style="opacity:.85"></i>
                        </div>
                        <div class="account-menu" id="accountMenu">
                            <div class="arrow"></div>
                            <a href="../pages/settings.html">Settings</a>
                            <a href="#" id="logoutBtn">Logout</a>
                        </div>
                    </div>
                </header>

                <section class="content">
                    <!-- Report Controls -->
                    <div class="report-controls">
                        <div class="controls-left">
                            <h1 class="page-title">Reports & Analytics</h1>
                            <div class="report-subtitle">Comprehensive insights into your support operations</div>
                        </div>
                        <div class="controls-right">
                            <div class="filter-group">
                                <label for="timeFilter">Time Range:</label>
                                <select id="timeFilter" class="filter-select">
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <button class="btn-export" id="exportBtn">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="totalTickets">142</div>
                                <div class="stat-label">Total Tickets</div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 12%
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="resolvedTickets">89</div>
                                <div class="stat-label">Resolved</div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 8%
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="satisfactionRate">94%</div>
                                <div class="stat-label">Satisfaction Rate</div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 3%
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Tickets by Status</h3>
                                <div class="chart-actions">
                                    <button class="chart-action-btn active" data-period="week">Week</button>
                                    <button class="chart-action-btn" data-period="month">Month</button>
                                    <button class="chart-action-btn" data-period="quarter">Quarter</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Tickets by Priority</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="priorityChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Resolution Time Trend</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="resolutionChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Ticket Volume</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="volumeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Reports Table -->
                    <div class="reports-table-container">
                        <div class="table-header">
                            <h3>Detailed Report</h3>
                            <div class="search-results-info" id="searchResultsInfo">
                                Showing all reports
                            </div>
                        </div>
                        <table class="reports-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>New Tickets</th>
                                    <th>Resolved</th>
                                    <th>Avg. Response</th>
                                    <th>Satisfaction</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTbody">
                                <!-- Reports data will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Footer -->
                <footer class="site-footer">
                    <div>&copy; 2025 Business Alliance Inc.</div>
                    <div>Dashboard Template</div>
                </footer>
            </main>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Export Report</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option">
                        <input type="radio" id="pdf" name="exportFormat" value="pdf" checked>
                        <label for="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <span>PDF Document</span>
                        </label>
                    </div>
                    <div class="export-option">
                        <input type="radio" id="excel" name="exportFormat" value="excel">
                        <label for="excel">
                            <i class="fas fa-file-excel"></i>
                            <span>Excel Spreadsheet</span>
                        </label>
                    </div>
                    <div class="export-option">
                        <input type="radio" id="csv" name="exportFormat" value="csv">
                        <label for="csv">
                            <i class="fas fa-file-csv"></i>
                            <span>CSV File</span>
                        </label>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Include Data</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Summary Statistics
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Charts & Graphs
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox"> Detailed Data Table
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="cancelExport">Cancel</button>
                    <button class="btn-primary" id="confirmExport">Export</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load and display user data from localStorage - EXACTLY as in index-admin.html
        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            
            if (userData) {
                // Display user name
                const userNameElement = document.getElementById('userName');
                if (userNameElement && userData.name) {
                    userNameElement.textContent = userData.name;
                }
                
                // Display user email
                const userEmailElement = document.getElementById('userEmail');
                if (userEmailElement && userData.email) {
                    userEmailElement.textContent = userData.email;
                }
                
                // Display avatar initials
                const userAvatarElement = document.getElementById('userAvatar');
                if (userAvatarElement && userData.name) {
                    // Get initials from name
                    const nameParts = userData.name.split(' ');
                    let initials = '';
                    
                    if (nameParts.length >= 2) {
                        initials = nameParts[0].charAt(0) + nameParts[1].charAt(0);
                    } else if (nameParts.length === 1) {
                        initials = nameParts[0].charAt(0);
                        if (nameParts[0].length > 1) {
                            initials += nameParts[0].charAt(1);
                        }
                    }
                    
                    userAvatarElement.textContent = initials.toUpperCase();
                }
            } else {
                // If no user data, redirect to login page
                window.location.href = '../../landing page/pages/index.html';
            }
        }
        
        // Call the function when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            initializeReportsPage();
        });

        // Dropdown toggle - EXACTLY as in index-admin.html
        const accountBtn = document.getElementById("accountBtn");
        const accountMenu = document.getElementById("accountMenu");

        if (accountBtn && accountMenu) {
            accountBtn.addEventListener("click", () => {
                accountMenu.classList.toggle("show");
                accountBtn.setAttribute("aria-expanded", accountMenu.classList.contains("show"));
            });

            window.addEventListener("click", (e) => {
                if (!accountBtn.contains(e.target) && !accountMenu.contains(e.target)) {
                    accountMenu.classList.remove("show");
                    accountBtn.setAttribute("aria-expanded", false);
                }
            });
        }

        // Logout functionality - EXACTLY as in index-admin.html
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();

                // Clear user data from localStorage
                localStorage.removeItem('userData');

                // Redirect to login page
                window.location.href = '../../landing page/pages/index.html';
            });
        }

        // Sample report data
        const reportData = {
            summary: {
                totalTickets: 142,
                resolvedTickets: 89,
                satisfactionRate: 94
            },
            statusData: {
                labels: ['Open', 'In Progress', 'Resolved'],
                data: [32, 21, 89],
                colors: ['#ef4444', '#f59e0b', '#10b981']
            },
            priorityData: {
                labels: ['High', 'Medium', 'Low'],
                data: [45, 67, 30],
                colors: ['#ef4444', '#f59e0b', '#10b981']
            },
            resolutionData: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                data: [3.2, 2.8, 2.5, 2.4]
            },
            volumeData: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                data: [120, 135, 142, 128, 156, 142]
            },
            detailedData: [
                { id: 1, date: '2025-11-24', category: 'Technical', newTickets: 15, resolved: 12, avgResponse: 2.1, satisfaction: 96, trend: 'up' },
                { id: 2, date: '2025-11-23', category: 'Billing', newTickets: 8, resolved: 7, avgResponse: 1.8, satisfaction: 92, trend: 'up' },
                { id: 3, date: '2025-11-22', category: 'General', newTickets: 12, resolved: 10, avgResponse: 2.5, satisfaction: 94, trend: 'down' },
                { id: 4, date: '2025-11-21', category: 'Technical', newTickets: 18, resolved: 14, avgResponse: 2.8, satisfaction: 91, trend: 'up' },
                { id: 5, date: '2025-11-20', category: 'Feature Request', newTickets: 5, resolved: 3, avgResponse: 3.2, satisfaction: 89, trend: 'down' },
                { id: 6, date: '2025-11-19', category: 'Technical', newTickets: 22, resolved: 18, avgResponse: 2.3, satisfaction: 95, trend: 'up' },
                { id: 7, date: '2025-11-18', category: 'Billing', newTickets: 6, resolved: 5, avgResponse: 1.5, satisfaction: 98, trend: 'up' },
                { id: 8, date: '2025-11-17', category: 'General', newTickets: 9, resolved: 8, avgResponse: 2.7, satisfaction: 90, trend: 'down' }
            ]
        };

        function initializeReportsPage() {
            // Initialize stats cards
            document.getElementById('totalTickets').textContent = reportData.summary.totalTickets;
            document.getElementById('resolvedTickets').textContent = reportData.summary.resolvedTickets;
            document.getElementById('satisfactionRate').textContent = `${reportData.summary.satisfactionRate}%`;

            // Initialize charts
            initializeCharts();
            renderDetailedReports(reportData.detailedData);
            setupReportEventListeners();
        }

        // Initialize charts
        function initializeCharts() {
            // Status Chart (Doughnut)
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: reportData.statusData.labels,
                    datasets: [{
                        data: reportData.statusData.data,
                        backgroundColor: reportData.statusData.colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '70%'
                }
            });

            // Priority Chart (Pie)
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: reportData.priorityData.labels,
                    datasets: [{
                        data: reportData.priorityData.data,
                        backgroundColor: reportData.priorityData.colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Resolution Chart (Line)
            const resolutionCtx = document.getElementById('resolutionChart').getContext('2d');
            new Chart(resolutionCtx, {
                type: 'line',
                data: {
                    labels: reportData.resolutionData.labels,
                    datasets: [{
                        label: 'Avg. Resolution Time (hrs)',
                        data: reportData.resolutionData.data,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Volume Chart (Bar)
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: reportData.volumeData.labels,
                    datasets: [{
                        label: 'Ticket Volume',
                        data: reportData.volumeData.data,
                        backgroundColor: 'rgba(59,130,246,0.8)',
                        borderColor: '#3B82F6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function setupReportEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const searchResultsInfo = document.getElementById('searchResultsInfo');
            const exportBtn = document.getElementById('exportBtn');
            const exportModal = document.getElementById('exportModal');
            const closeModal = document.querySelector('.close');
            const cancelExport = document.getElementById('cancelExport');
            const confirmExport = document.getElementById('confirmExport');
            const timeFilter = document.getElementById('timeFilter');
            const chartActionBtns = document.querySelectorAll('.chart-action-btn');

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }

            function handleSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    renderDetailedReports(reportData.detailedData);
                    searchResultsInfo.textContent = 'Showing all reports';
                    return;
                }
                
                const filteredReports = reportData.detailedData.filter(report => {
                    return (
                        report.date.toLowerCase().includes(searchTerm) ||
                        report.category.toLowerCase().includes(searchTerm) ||
                        report.newTickets.toString().includes(searchTerm) ||
                        report.resolved.toString().includes(searchTerm) ||
                        report.avgResponse.toString().includes(searchTerm) ||
                        report.satisfaction.toString().includes(searchTerm) ||
                        report.trend.toLowerCase().includes(searchTerm)
                    );
                });
                
                renderDetailedReports(filteredReports);
                searchResultsInfo.textContent = `Showing ${filteredReports.length} of ${reportData.detailedData.length} reports`;
            }

            // Export functionality
            if (exportBtn) {
                exportBtn.addEventListener('click', openExportModal);
            }

            function openExportModal() {
                exportModal.style.display = 'block';
            }

            if (closeModal) {
                closeModal.addEventListener('click', closeExportModal);
            }

            if (cancelExport) {
                cancelExport.addEventListener('click', closeExportModal);
            }

            if (confirmExport) {
                confirmExport.addEventListener('click', handleExport);
            }

            function closeExportModal() {
                exportModal.style.display = 'none';
            }

            function handleExport() {
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                alert(`Exporting report as ${format.toUpperCase()}...`);
                closeExportModal();
            }

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === exportModal) {
                    closeExportModal();
                }
            });

            // Time filter functionality
            if (timeFilter) {
                timeFilter.addEventListener('change', function() {
                    const period = timeFilter.value;
                    console.log(`Filtering data for: ${period}`);
                });
            }

            // Chart period buttons
            if (chartActionBtns) {
                chartActionBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        chartActionBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        updateCharts(this.getAttribute('data-period'));
                    });
                });
            }

            function updateCharts(period) {
                console.log(`Updating charts for period: ${period}`);
            }
        }

        // Render detailed reports table
        function renderDetailedReports(reportsToRender) {
            const reportsTbody = document.getElementById('reportsTbody');
            if (!reportsTbody) return;
            
            reportsTbody.innerHTML = '';
            
            if (reportsToRender.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="7" class="no-results">
                        <i class="fas fa-search"></i>
                        <div>No reports found matching your search criteria</div>
                    </td>
                `;
                reportsTbody.appendChild(tr);
                return;
            }
            
            reportsToRender.forEach(report => {
                const tr = document.createElement('tr');
                
                // Determine trend icon
                let trendIcon = '';
                if (report.trend === 'up') {
                    trendIcon = '<i class="fas fa-arrow-up trend-up"></i>';
                } else {
                    trendIcon = '<i class="fas fa-arrow-down trend-down"></i>';
                }
                
                tr.innerHTML = `
                    <td>${report.date}</td>
                    <td>${report.category}</td>
                    <td>${report.newTickets}</td>
                    <td>${report.resolved}</td>
                    <td>${report.avgResponse} hrs</td>
                    <td>${report.satisfaction}%</td>
                    <td>${trendIcon}</td>
                `;
                
                reportsTbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>