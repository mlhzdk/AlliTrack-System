<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-translate="my_tickets_page_title">My Tickets - AlliTrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="../css/sidebar-header.css" />
    <link rel="stylesheet" href="../css/my-tickets.css" />
    <script src="../js/preference-manager.js"></script>
    <script src="../js/user-data-manager.js"></script>
</head>

<body>
    <!-- Main Content -->
    <div class="app">
        <div class="shell">
            <!-- Sidebar -->
            <aside class="sidebar" role="navigation" aria-label="Main Sidebar">
                <div class="brand">
                    <div class="logo">
                        <img src="../pictures/AlliTrack Logo.png" alt="AlliTrack Logo" class="logo-img"
                            style="width: 32px; height: 32px;">
                    </div>
                    <div>
                        <div class="title">AlliTrack</div>
                        <div class="subtitle" data-translate="user_dashboard">User Dashboard</div>
                    </div>
                </div>
                <nav class="nav">
                    <a href="../pages/index-user.html" data-section="dashboard">
                        <i class="fas fa-chart-line"></i> <span data-translate="dashboard">Dashboard</span>
                    </a>

                    <div class="nav-section" data-translate="support">Support</div>
                    <a href="../pages/my-tickets.html" class="active" data-section="tickets">
                        <i class="fas fa-ticket-alt"></i> <span data-translate="my_tickets">Ticket</span>
                    </a>
                    <a href="../pages/notifications.html" data-section="notifications">
                        <i class="fas fa-bell"></i> <span data-translate="notifications">Alert</span>
                    </a>
                    <a href="../pages/submit-ticket.html" data-section="submit-ticket">
                        <i class="fas fa-plus-circle"></i> <span data-translate="submit_ticket">New</span>
                    </a>

                    <div class="nav-section" data-translate="management">Manage</div>
                    <a href="../pages/preferences.html" data-section="preferences">
                        <i class="fas fa-sliders-h"></i> <span data-translate="preferences">Settings</span>
                    </a>
                    <a href="../pages/profile-settings.html" data-section="profile-settings">
                        <i class="fas fa-user-cog"></i> <span data-translate="profile_settings">Profile</span>
                    </a>
                    <a href="../pages/announcements.html" data-section="announcements">
                        <i class="fas fa-bullhorn"></i> <span data-translate="announcements">Anunsyo</span>
                    </a>

                    <div class="nav-section" data-translate="system">System</div>
                    <a href="../pages/account-security.html" data-section="account-security">
                        <i class="fas fa-shield-alt"></i> <span data-translate="account_security">Security</span>
                    </a>
                    <a href="../pages/system-information.html" data-section="system-information">
                        <i class="fas fa-info-circle"></i> <span data-translate="system_information">Info</span>
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <div class="version">v1.2.0</div>
                    <div>Business Alliance Inc.</div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main">
                <!-- Header -->
                <header class="header">
                    <div class="search" role="search" aria-label="Search Tickets">
                        <i class="fas fa-search" style="opacity:.6"></i>
                        <input id="q" placeholder="Search tickets, users, IDs..."
                            data-translate-placeholder="search_tickets" aria-label="Search tickets, users, IDs" />
                    </div>
                    <div class="header-actions">
                        <div style="text-align:right">
                            <div id="userName" style="font-weight:700">User</div>
                            <div id="userEmail" style="font-size:.82rem;color:var(--muted)">user@example.com</div>
                        </div>
                        <div class="account" id="accountBtn" aria-haspopup="true" aria-expanded="false">
                            <div id="userAvatar" class="avatar">U</div>
                            <i class="fas fa-chevron-down" style="opacity:.85"></i>
                        </div>
                        <div class="account-menu" id="accountMenu">
                            <div class="arrow"></div>
                            <a href="../pages/profile-settings.html" data-translate="profile">Profile</a>
                            <a href="../pages/preferences.html" data-translate="settings">Settings</a>
                            <a href="#" id="logoutBtn" data-translate="logout">Logout</a>
                        </div>
                    </div>
                </header>

                <!-- My Tickets Content -->
                <div class="content">
                    <div class="tickets-content">
                        <!-- Header with Container -->
                        <div class="tickets-header-container">
                            <div class="tickets-header">
                                <h1><i class="fas fa-ticket-alt"></i> <span data-translate="my_tickets_title">My
                                        Tickets</span></h1>
                                <div class="tickets-controls">
                                    <div class="filter-group">
                                        <select class="filter-select" id="statusFilter">
                                            <option value="all">All Status</option>
                                            <option value="open">Open</option>
                                            <option value="pending">Pending</option>
                                            <option value="resolved">Resolved</option>
                                            <option value="closed">Closed</option>
                                        </select>

                                        <select class="filter-select" id="priorityFilter">
                                            <option value="all">All Priority</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>

                                        <select class="filter-select" id="sortFilter">
                                            <option value="newest">Newest First</option>
                                            <option value="oldest">Oldest First</option>
                                            <option value="updated">Latest Update</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tickets-grid" id="ticketsContainer">
                            <!-- Tickets will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="site-footer">
                    <div>&copy; 2025 Business Alliance Inc.</div>
                    <div data-translate="dashboard_template">Dashboard Template</div>
                </footer>
            </main>
        </div>
    </div>

    <script>
        // Translation dictionary for my tickets page
        const translations = {
            'en': {
                // PAGE-SPECIFIC translations only:
                'my_tickets_page_title': 'My Tickets - AlliTrack',
                'my_tickets_title': 'My Tickets',
                'search_tickets': 'Search tickets, users, IDs...',

                // Filter options
                'all_status': 'All Status',
                'open_status': 'Open',
                'pending_status': 'Pending',
                'resolved_status': 'Resolved',
                'closed_status': 'Closed',
                'all_priority': 'All Priority',
                'low_priority': 'Low',
                'medium_priority': 'Medium',
                'high_priority': 'High',
                'critical_priority': 'Critical',
                'newest_first': 'Newest First',
                'oldest_first': 'Oldest First',
                'latest_update': 'Latest Update',

                // Ticket details
                'created': 'Created',
                'updated': 'Updated',
                'view': 'View',
                'comment': 'Comment',
                'no_tickets': 'No tickets found',
                'try_filters': 'Try adjusting your filters or search terms',
                'assigned_to': 'Assigned to',
                'today': 'Today',
                'yesterday': 'Yesterday',
                'days_ago': 'days ago',

                // Navigation (shared with dashboard)
                'user_dashboard': 'User Dashboard',
                'dashboard': 'Dashboard',
                'support': 'Support',
                'my_tickets': 'Ticket',
                'notifications': 'Alert',
                'submit_ticket': 'New',
                'management': 'Manage',
                'preferences': 'Settings',
                'profile_settings': 'Profile',
                'announcements': 'Anunsyo',
                'system': 'System',
                'account_security': 'Security',
                'system_information': 'Info',
                'profile': 'Profile',
                'settings': 'Settings',
                'logout': 'Logout',
                'dashboard_template': 'Dashboard Template'
            },
            'fil': {
                // PAGE-SPECIFIC translations only:
                'my_tickets_page_title': 'Aking Ticket - AlliTrack',
                'my_tickets_title': 'Aking Ticket',
                'search_tickets': 'Maghanap...',

                // Filter options
                'all_status': 'Lahat Status',
                'open_status': 'Bukas',
                'pending_status': 'Pending',
                'resolved_status': 'Resolved',
                'closed_status': 'Closed',
                'all_priority': 'Lahat Priority',
                'low_priority': 'Mababa',
                'medium_priority': 'Katamtaman',
                'high_priority': 'Mataas',
                'critical_priority': 'Critical',
                'newest_first': 'Pinakabago',
                'oldest_first': 'Pinakaluma',
                'latest_update': 'Latest Update',

                // Ticket details
                'created': 'Ginawa',
                'updated': 'Update',
                'view': 'Tingnan',
                'comment': 'Comment',
                'no_tickets': 'Walang ticket',
                'try_filters': 'Baguhin filter o search',
                'assigned_to': 'I-assign kay',
                'today': 'Ngayon',
                'yesterday': 'Kahapon',
                'days_ago': 'araw ang nakalipas',

                // Navigation (shared with dashboard)
                'user_dashboard': 'Dashboard',
                'dashboard': 'Dashboard',
                'support': 'Suporta',
                'my_tickets': 'Ticket',
                'notifications': 'Alert',
                'submit_ticket': 'New',
                'management': 'Manage',
                'preferences': 'Settings',
                'profile_settings': 'Profile',
                'announcements': 'Anunsyo',
                'system': 'System',
                'account_security': 'Security',
                'system_information': 'Info',
                'profile': 'Profile',
                'settings': 'Settings',
                'logout': 'Logout',
                'dashboard_template': 'Dashboard'
            }
        };

        // Sample ticket data
        const tickets = [
            {
                id: "TKT-4587",
                title: "Login authentication issue",
                description: "Unable to login to the system with correct credentials. Getting 'Invalid credentials' error even though password is correct.",
                status: "open",
                priority: "high",
                createdAt: "2025-03-15T10:30:00",
                updatedAt: "2025-03-16T14:20:00",
                assignee: { name: "John Smith", initials: "JS" },
                category: "Authentication"
            },
            {
                id: "TKT-4219",
                title: "Dashboard not loading properly",
                description: "Dashboard widgets are not loading correctly on mobile devices. Some charts are cut off and data is not displaying properly.",
                status: "resolved",
                priority: "medium",
                createdAt: "2025-03-10T09:15:00",
                updatedAt: "2025-03-14T16:45:00",
                assignee: { name: "Sarah Johnson", initials: "SJ" },
                category: "UI/UX"
            },
            {
                id: "TKT-4392",
                title: "Email notifications not being sent",
                description: "System is not sending email notifications for ticket updates and status changes. Checked spam folder and email settings.",
                status: "pending",
                priority: "critical",
                createdAt: "2025-03-12T14:20:00",
                updatedAt: "2025-03-16T11:30:00",
                assignee: { name: "Mike Davis", initials: "MD" },
                category: "Notifications"
            },
            {
                id: "TKT-4125",
                title: "Report generation slow",
                description: "Generating monthly reports takes more than 5 minutes. This is significantly slower than before the last update.",
                status: "closed",
                priority: "low",
                createdAt: "2025-02-28T11:45:00",
                updatedAt: "2025-03-05T09:10:00",
                assignee: { name: "Emily Wilson", initials: "EW" },
                category: "Performance"
            },
            {
                id: "TKT-4673",
                title: "Unable to upload large files",
                description: "Getting error when trying to upload files larger than 10MB. The system should support up to 50MB according to documentation.",
                status: "open",
                priority: "medium",
                createdAt: "2025-03-17T08:50:00",
                updatedAt: "2025-03-17T08:50:00",
                assignee: { name: "Alex Brown", initials: "AB" },
                category: "File Management"
            }
        ];

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('My Tickets: Starting initialization...');

            // Initialize user data manager FIRST
            if (window.userDataManager) {
                console.log('User Data Manager found, initializing user display...');
                window.userDataManager.initializeUserDisplay();

                // Check what user data is available
                const userData = window.userDataManager.getUserData();
                console.log('User Data from manager:', userData);
                console.log('Profile picture URL:', userData.photo);
            } else {
                console.error('User Data Manager NOT FOUND! Check if user-data-manager.js is loaded.');
            }

            // Initialize preferences manager
            if (window.preferencesManager) {
                console.log('My Tickets: Initializing Preferences Manager...');
                window.preferencesManager.initialize();

                // Apply theme immediately
                window.preferencesManager.applyTheme();

                // Get current language from preferences manager
                const currentLang = window.preferencesManager.getCurrentLanguage() || 'en';
                applyTranslations(currentLang);
            } else {
                console.error('My Tickets: preferencesManager not found!');
                applyTranslations('en'); // Default to English
            }

            // Setup theme listener
            setupThemeListener();

            // Initialize tickets functionality
            initTickets();

            // Setup logout functionality - MUST BE CALLED BEFORE setupAccountDropdown
            setupLogout();

            // SETUP ACCOUNT DROPDOWN - CRITICAL ADDITION (from system-information.html)
            setupAccountDropdown();

            console.log('My Tickets page loaded');
        });

        // Setup theme listener
        function setupThemeListener() {
            console.log('Setting up theme listener for my tickets...');

            // Listen for theme changes via storage events
            window.addEventListener('storage', (event) => {
                if (event.key === 'preferredTheme') {
                    console.log('Theme changed via storage:', event.newValue);
                    if (window.preferencesManager) {
                        setTimeout(() => {
                            window.preferencesManager.applyTheme();
                        }, 100);
                    }
                }
            });

            // Listen for theme changes via broadcast
            document.addEventListener('themeChanged', function (e) {
                console.log('Theme changed via event:', e.detail.theme);
                if (window.preferencesManager) {
                    window.preferencesManager.applyTheme();
                }
            });
        }

        // Apply translations to the page
        function applyTranslations(language) {
            const lang = translations[language] ? language : 'en';
            const dict = translations[lang];

            // Translate all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (dict[key]) {
                    element.textContent = dict[key];
                }
            });

            // Translate all placeholder texts
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (dict[key]) {
                    element.placeholder = dict[key];
                }
            });

            // Update page title
            if (dict['my_tickets_page_title']) {
                document.title = dict['my_tickets_page_title'];
            }

            // Re-render tickets with new language
            if (filterAndSortTickets) {
                filterAndSortTickets();
            }
        }

        // Listen for language changes from preference-manager.js
        document.addEventListener('languageChanged', function (e) {
            console.log('Language changed to:', e.detail.language);
            applyTranslations(e.detail.language);
        });

        // Logout functionality - FIXED VERSION
        function setupLogout() {
            // First remove any existing logout buttons to avoid duplicates
            const existingLogoutBtns = document.querySelectorAll('#logoutBtn');
            existingLogoutBtns.forEach(btn => {
                const parent = btn.parentNode;
                const newBtn = btn.cloneNode(true);
                parent.replaceChild(newBtn, btn);
            });

            // Now attach the event listener to the fresh logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                console.log('Setting up logout button...');

                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log('Logout button clicked!');

                    // Clear user data from localStorage
                    localStorage.removeItem('userData');
                    localStorage.removeItem('userProfile');
                    localStorage.removeItem('userTickets');
                    localStorage.removeItem('preferredTheme');
                    localStorage.removeItem('preferredLanguage');

                    console.log('Cleared localStorage, redirecting to login...');

                    // Redirect to login page
                    window.location.href = '../../landing page/pages/index.html';
                });
            } else {
                console.error('Logout button not found after refresh!');
            }
        }

        // Format date function
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format relative time WITH TRANSLATIONS
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMs = now - date;
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

            // Get current language
            const currentLang = window.preferencesManager ?
                window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            if (diffInDays === 0) {
                return dict['today'] || 'Today';
            } else if (diffInDays === 1) {
                return dict['yesterday'] || 'Yesterday';
            } else if (diffInDays < 7) {
                return `${diffInDays} ${dict['days_ago'] || 'days ago'}`;
            } else {
                return formatDate(dateString);
            }
        }

        // Render tickets
        function renderTickets(ticketsToRender) {
            const ticketsContainer = document.getElementById('ticketsContainer');
            const currentLang = window.preferencesManager ? window.preferencesManager.getCurrentLanguage() : 'en';
            const dict = translations[currentLang] || translations['en'];

            if (!ticketsContainer) return;

            ticketsContainer.innerHTML = '';

            if (ticketsToRender.length === 0) {
                ticketsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-ticket-alt"></i>
                    <h3>${dict['no_tickets'] || 'No tickets found'}</h3>
                    <p>${dict['try_filters'] || 'Try adjusting your filters or search terms'}</p>
                </div>
            `;
                return;
            }

            ticketsToRender.forEach(ticket => {
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-card';
                ticketElement.innerHTML = `
                <div class="ticket-header">
                    <div>
                        <div class="ticket-title">${ticket.title}</div>
                        <div class="ticket-id">${ticket.id}</div>
                    </div>
                    <div class="ticket-status status-${ticket.status}">${ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1)}</div>
                </div>
                <div class="ticket-meta">
                    <span class="ticket-priority priority-${ticket.priority}">
                        <i class="fas fa-flag"></i> ${ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1)}
                    </span>
                    <div class="ticket-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>${dict['created'] || 'Created'}: ${formatDate(ticket.createdAt)}</span>
                    </div>
                    <div class="ticket-meta-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>${dict['updated'] || 'Updated'}: ${formatRelativeTime(ticket.updatedAt)}</span>
                    </div>
                    <div class="ticket-meta-item">
                        <i class="fas fa-tag"></i>
                        <span>${ticket.category}</span>
                    </div>
                </div>
                <div class="ticket-description">${ticket.description}</div>
                <div class="ticket-footer">
                    <div class="ticket-assignee">
                        <div class="assignee-avatar">${ticket.assignee.initials}</div>
                        <div class="assignee-name">${dict['assigned_to'] || 'Assigned to'} ${ticket.assignee.name}</div>
                    </div>
                    <div class="ticket-actions">
                        <button class="ticket-action-btn" data-id="${ticket.id}">
                            <i class="fas fa-eye"></i> ${dict['view'] || 'View'}
                        </button>
                        <button class="ticket-action-btn" data-id="${ticket.id}">
                            <i class="fas fa-comment"></i> ${dict['comment'] || 'Comment'}
                        </button>
                    </div>
                </div>
            `;
                ticketsContainer.appendChild(ticketElement);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.ticket-action-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const ticketId = this.getAttribute('data-id');
                    const ticket = tickets.find(t => t.id === ticketId);
                    if (ticket) {
                        alert(`Viewing ticket: ${ticket.id}\n\n${ticket.title}`);
                    }
                });
            });
        }

        // Filter and sort tickets
        function filterAndSortTickets() {
            let filteredTickets = [...tickets];

            // Get filter elements
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const sortFilter = document.getElementById('sortFilter');
            const searchInput = document.getElementById('q');

            if (!statusFilter || !priorityFilter || !sortFilter || !searchInput) return;

            // Apply status filter
            if (statusFilter.value !== 'all') {
                filteredTickets = filteredTickets.filter(ticket => ticket.status === statusFilter.value);
            }

            // Apply priority filter
            if (priorityFilter.value !== 'all') {
                filteredTickets = filteredTickets.filter(ticket => ticket.priority === priorityFilter.value);
            }

            // Apply search filter
            if (searchInput.value.trim() !== '') {
                const searchTerm = searchInput.value.toLowerCase();
                filteredTickets = filteredTickets.filter(ticket =>
                    ticket.title.toLowerCase().includes(searchTerm) ||
                    ticket.id.toLowerCase().includes(searchTerm) ||
                    ticket.description.toLowerCase().includes(searchTerm)
                );
            }

            // Apply sorting
            switch (sortFilter.value) {
                case 'oldest':
                    filteredTickets.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'updated':
                    filteredTickets.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    break;
                case 'newest':
                default:
                    filteredTickets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
            }

            renderTickets(filteredTickets);
        }

        // Initialize tickets functionality
        function initTickets() {
            // Add event listeners for filters and search
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const sortFilter = document.getElementById('sortFilter');
            const searchInput = document.getElementById('q');

            if (statusFilter) statusFilter.addEventListener('change', filterAndSortTickets);
            if (priorityFilter) priorityFilter.addEventListener('change', filterAndSortTickets);
            if (sortFilter) sortFilter.addEventListener('change', filterAndSortTickets);
            if (searchInput) searchInput.addEventListener('input', filterAndSortTickets);

            // Initial render
            filterAndSortTickets();
        }

        // Account Dropdown Functionality - FIXED VERSION (with logout support)
        function setupAccountDropdown() {
            console.log('Setting up account dropdown for my-tickets...');
            const accountBtn = document.getElementById("accountBtn");
            const accountMenu = document.getElementById("accountMenu");

            console.log('Dropdown elements:', { accountBtn, accountMenu });

            if (accountBtn && accountMenu) {
                // Clear any existing event listeners by cloning
                const newBtn = accountBtn.cloneNode(true);
                accountBtn.parentNode.replaceChild(newBtn, accountBtn);

                const refreshedBtn = document.getElementById("accountBtn");
                const refreshedMenu = document.getElementById("accountMenu");

                // Add click event to toggle dropdown
                refreshedBtn.addEventListener("click", function (e) {
                    console.log('Account button clicked!');
                    e.stopPropagation();
                    e.preventDefault();

                    const isShowing = refreshedMenu.classList.contains("show");
                    console.log('Current show state:', isShowing);

                    refreshedMenu.classList.toggle("show");
                    refreshedBtn.setAttribute("aria-expanded", !isShowing);
                    console.log('New show state:', !isShowing);
                });

                // Close dropdown when clicking outside
                document.addEventListener("click", function (e) {
                    if (!refreshedBtn.contains(e.target) && !refreshedMenu.contains(e.target)) {
                        refreshedMenu.classList.remove("show");
                        refreshedBtn.setAttribute("aria-expanded", false);
                    }
                });

                // Close dropdown when pressing Escape key
                document.addEventListener("keydown", function (e) {
                    if (e.key === "Escape" && refreshedMenu.classList.contains("show")) {
                        refreshedMenu.classList.remove("show");
                        refreshedBtn.setAttribute("aria-expanded", false);
                    }
                });

                // Make sure button is clickable
                refreshedBtn.style.cursor = 'pointer';

                // IMPORTANT: DON'T re-attach click listeners to menu items here
                // because setupLogout() already handles the logout button
                // and other links are regular href links that don't need JS

                console.log('Account dropdown setup complete for my-tickets');
            } else {
                console.error('Account dropdown elements not found in my-tickets!');
            }
        }

        // Listen for user data changes
        document.addEventListener('userDataChanged', function (e) {
            console.log('User data changed event received:', e.detail);
            // The userDataManager will handle updating the avatar automatically
        });
    </script>
</body>

</html>